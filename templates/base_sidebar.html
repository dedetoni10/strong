<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Strong Order Management{% endblock %}</title>
    
    <!-- 10x ULTRA: Performance optimizations -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Strong Order Management System - 10x Ultra Fast Warehouse Management">
    <meta name="robots" content="noindex, nofollow">
    <link rel="dns-prefetch" href="//cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
    <link rel="preconnect" href="//cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="//cdnjs.cloudflare.com" crossorigin>
    
    <!-- 10x ULTRA: Critical CSS inline for instant loading -->
    <style>
        body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;margin:0;padding:0;background:#f8f9fa;overflow-x:hidden}
        .navbar{background:#8B5CF6!important;box-shadow:0 2px 4px rgba(0,0,0,.1)}
        .sidebar{background:#2d3748;min-height:100vh;position:fixed;top:0;left:0;width:250px;z-index:1000}
        .main-content{margin-left:250px;padding:20px;min-height:100vh}
        .card{border:none;box-shadow:0 2px 8px rgba(0,0,0,.1);margin-bottom:1rem;border-radius:.5rem}
        .card-header{background:#8B5CF6;color:#fff;font-weight:600;border-radius:.5rem .5rem 0 0}
        .btn-primary{background:#8B5CF6;border:#8B5CF6;transition:all .2s}
        .btn-primary:hover{background:#7C3AED;border:#7C3AED;transform:translateY(-1px)}
        .table{margin-bottom:0}
        .nav-link{color:#e2e8f0!important;padding:.75rem 1rem;transition:all .2s}
        .nav-link:hover{background:rgba(255,255,255,.1);color:#fff!important}
        .nav-link.active{background:#8B5CF6;color:#fff!important}
        .loading{display:none!important}
        @media (max-width:768px){.sidebar{width:100%;height:auto;position:relative}.main-content{margin-left:0}}
    </style>
    
    <!-- 10x ULTRA: Async CSS loading for maximum speed -->
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'" crossorigin>
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'" crossorigin>
    <noscript>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    </noscript>
    
    <style>
        body {
            margin: 0 !important;
            padding: 0 !important;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            overflow-x: hidden;
        }

        /* Force remove any debug or unwanted borders */
        * {
            outline: none !important;
            border: none !important;
            pointer-events: auto !important; /* Ensure all elements are clickable */
        }
        
        /* Restore necessary borders for cards and components */
        .card, .card-header, .card-body, .card-footer {
            border: 1px solid rgba(0,0,0,.125) !important;
            border-radius: 0.375rem !important;
        }
        
        .table th, .table td {
            border-top: 1px solid #dee2e6 !important;
        }
        
        .btn {
            border: 1px solid transparent !important;
            border-radius: 0.375rem !important;
        }
        
        /* Restore form element borders - CRITICAL FIX */
        input[type="text"], 
        input[type="email"], 
        input[type="password"], 
        input[type="number"], 
        input[type="search"],
        input[type="tel"],
        input[type="url"],
        textarea, 
        select {
            border: 1px solid #ced4da !important;
            border-radius: 0.375rem !important;
            padding: 0.375rem 0.75rem !important;
            background-color: #fff !important;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out !important;
            cursor: pointer !important;
            pointer-events: auto !important;
        }
        
        input[type="text"]:focus, 
        input[type="email"]:focus, 
        input[type="password"]:focus, 
        input[type="number"]:focus, 
        input[type="search"]:focus,
        input[type="tel"]:focus,
        input[type="url"]:focus,
        textarea:focus, 
        select:focus {
            border-color: #86b7fe !important;
            outline: 0 !important;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25) !important;
        }
        
        /* Restore checkbox appearance - CRITICAL FIX */
        input[type="checkbox"] {
            border: 1px solid #ced4da !important;
            border-radius: 0.25em !important;
            width: 1em !important;
            height: 1em !important;
            background-color: #fff !important;
            background-repeat: no-repeat !important;
            background-position: center !important;
            background-size: contain !important;
            appearance: none !important;
            -webkit-appearance: none !important;
            position: relative !important;
            display: inline-block !important;
            vertical-align: middle !important;
        }
        
        input[type="checkbox"]:checked {
            background-color: #0d6efd !important;
            border-color: #0d6efd !important;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'%3e%3cpath fill='none' stroke='%23fff' stroke-linecap='round' stroke-linejoin='round' stroke-width='3' d='m6 10 3 3 6-6'/%3e%3c/svg%3e") !important;
        }
        
        input[type="checkbox"]:focus {
            border-color: #86b7fe !important;
            outline: 0 !important;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25) !important;
        }
        
        /* Restore radio button appearance */
        input[type="radio"] {
            border: 1px solid #ced4da !important;
            border-radius: 50% !important;
            width: 1em !important;
            height: 1em !important;
            background-color: #fff !important;
            appearance: none !important;
            -webkit-appearance: none !important;
            position: relative !important;
            display: inline-block !important;
            vertical-align: middle !important;
        }
        
        input[type="radio"]:checked {
            background-color: #0d6efd !important;
            border-color: #0d6efd !important;
        }
        
        input[type="radio"]:checked::before {
            content: '' !important;
            position: absolute !important;
            top: 50% !important;
            left: 50% !important;
            width: 0.375em !important;
            height: 0.375em !important;
            border-radius: 50% !important;
            background-color: #fff !important;
            transform: translate(-50%, -50%) !important;
        }

        .sidebar {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            height: 100vh !important;
            width: 250px !important;
            background: linear-gradient(135deg, #6f42c1, #8b5cf6);
            padding: 20px 0;
            z-index: 1000 !important;
            overflow-y: auto;
            box-sizing: border-box;
        }

        .sidebar .logo {
            text-align: center;
            margin-bottom: 30px;
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
            padding: 0 20px;
        }

        .sidebar .nav-item {
            margin-bottom: 5px;
        }

        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 12px 20px;
            text-decoration: none;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
            border-radius: 0;
            cursor: pointer !important;
            pointer-events: auto !important;
            cursor: pointer !important;
            pointer-events: auto !important;
        }

        .sidebar .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .sidebar .nav-link.active {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .sidebar .nav-link i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        .main-content {
            margin-left: 250px !important;
            padding: 20px;
            background-color: #f8f9fa;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .content-header {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .content-header h1 {
            margin: 0;
            color: #6f42c1;
            font-size: 1.5rem;
        }

        .content-header p {
            margin: 5px 0 0 0;
            color: #6c757d;
            font-size: 0.9rem;
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-card .icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            color: white;
            font-size: 1.5rem;
        }

        .stat-card .icon.blue { background-color: #3498db; }
        .stat-card .icon.green { background-color: #27ae60; }
        .stat-card .icon.orange { background-color: #f39c12; }
        .stat-card .icon.cyan { background-color: #17a2b8; }

        .stat-card h3 {
            font-size: 1.8rem;
            margin: 0;
            color: #6f42c1;
        }

        .stat-card p {
            margin: 5px 0 0 0;
            color: #6c757d;
            font-size: 0.9rem;
        }

        .content-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .content-card-header {
            background: linear-gradient(135deg, #6f42c1, #8b5cf6);
            color: white;
            padding: 15px 20px;
            font-weight: 600;
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .content-card-body {
            padding: 20px;
        }

        .table {
            margin-bottom: 0;
        }

        .table thead th {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            color: #495057;
            font-weight: 600;
        }

        .btn-primary {
            background: linear-gradient(135deg, #6f42c1, #8b5cf6);
            border: none;
            border-radius: 5px;
            padding: 8px 16px;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #5a359a, #7c3aed);
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 0.875rem;
        }

        .badge {
            font-size: 0.75rem;
            padding: 4px 8px;
        }

        .search-box {
            position: relative;
            margin-bottom: 20px;
        }

        .search-box input {
            padding-left: 40px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
        }

        .search-box i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }

        /* Dropdown Submenu Styles */
        .dropdown-menu-item {
            position: relative;
        }
        
        .dropdown-toggle {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }
        
        .dropdown-toggle::after {
            display: none !important;
        }
        
        .dropdown-toggle::before {
            display: none !important;
        }
        
        .nav-link::after {
            display: none !important;
        }
        
        .nav-link::before {
            display: none !important;
        }
        
        .dropdown-menu-item a::after {
            display: none !important;
        }
        
        .dropdown-menu-item a::before {
            display: none !important;
        }
        
        .dropdown-menu-item::after {
            display: none !important;
        }
        
        .dropdown-menu-item::before {
            display: none !important;
        }
        
        /* Hide all Bootstrap dropdown indicators and pseudo-elements */
        .dropdown-toggle::after,
        .dropdown-toggle::before,
        .dropdown-menu-item::after,
        .dropdown-menu-item::before,
        .dropdown-menu-item a::after,
        .dropdown-menu-item a::before,
        .nav-link::after,
        .nav-link::before,
        .nav-item::after,
        .nav-item::before,
        .dropdown::after,
        .dropdown::before,
        .dropdown-item::after,
        .dropdown-item::before {
            display: none !important;
            content: none !important;
        }
        
        .dropdown-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        
        .dropdown-toggle span {
            display: flex;
            align-items: center;
        }
        
        .dropdown-toggle span i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        .dropdown-arrow {
            font-size: 12px;
            transition: transform 0.3s ease;
            margin-left: auto;
            padding-right: 5px;
            display: flex;
            align-items: center;
            height: 100%;
        }
        
        .dropdown-arrow.rotated {
            transform: rotate(90deg);
        }
        
        .dropdown-submenu {
            background-color: #5a359a;
            border-left: 3px solid #8B5CF6;
            margin-left: 15px;
            border-radius: 0 5px 5px 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .submenu-item {
            padding-left: 30px !important;
            font-size: 14px !important;
            color: rgba(255, 255, 255, 0.8) !important;
            border-left: 2px solid transparent;
            background-color: rgba(139, 92, 246, 0.3) !important;
        }
        
        .submenu-item:hover {
            background-color: rgba(139, 92, 246, 0.6) !important;
            border-left-color: #fff !important;
            color: white !important;
        }
        
        .submenu-item.active {
            background-color: #8B5CF6 !important;
            border-left-color: #fff !important;
            color: white !important;
        }
        
        .submenu-item i {
            margin-right: 8px;
            width: 16px;
            font-size: 12px;
        }
        
        /* CRITICAL FIX: Ensure all clickable elements work */
        a, button, input, select, .nav-link, .dropdown-toggle, .submenu-item {
            cursor: pointer !important;
            pointer-events: auto !important;
            z-index: 9999 !important;
        }
        
        /* CRITICAL FIX: Specifically for dropdown menus */
        .dropdown-submenu, .dropdown-menu-item, #storeDropdown, #scanCenterDropdown {
            pointer-events: auto !important;
            z-index: 9999 !important;
        }
        
        /* CRITICAL FIX: Form elements must be clickable */
        select.form-select, input.form-control {
            cursor: pointer !important;
            pointer-events: auto !important;
            z-index: 9999 !important;
            position: relative !important;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }
            
            .main-content {
                margin-left: 0;
            }
        }

        /* Remove underlines from all headings */
        h1, h2, h3, h4, h5, h6 {
            text-decoration: none !important;
            border-bottom: none !important;
        }

        .card-title {
            text-decoration: none !important;
            border-bottom: none !important;
        }

        .card-header h5, .card-header h6 {
            text-decoration: none !important;
            border-bottom: none !important;
        }

        /* Force remove all underlines globally */
        * {
            text-decoration: none !important;
        }

        a {
            text-decoration: none !important;
        }
        
        /* Responsive Design for Mobile */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0 !important;
                padding: 15px;
            }
        }
        
        /* Ensure no horizontal scroll */
        html, body {
            overflow-x: hidden !important;
            max-width: 100% !important;
        }
        
        /* Force layout consistency */
        .container-fluid, .row, .col-12 {
            max-width: 100% !important;
            overflow-x: hidden !important;
        }
    </style>
    
    {% block extra_css %}{% endblock %}
</head>
<body>
    <div class="sidebar">
        <div class="logo">
            <i class="fas fa-cube"></i> STRONG
        </div>
        <nav class="nav flex-column">
            <!-- Dashboard - Admin only, NOT for tonidede1 -->
            {% if session.username != 'tonidede1' and 'admin' in session.get('user_role', '') %}
            <a class="nav-link {% if request.endpoint == 'dashboard' %}active{% endif %}" href="{{ url_for('dashboard') }}" onclick="loadPage(event, '{{ url_for('dashboard') }}', 'Dashboard')">
                <i class="fas fa-home"></i> Dashboard
            </a>
            {% endif %}
            
            <!-- Admin-only menu items (NOT for tonidede1) -->
            {% if session.username != 'tonidede1' and session.user_role == 'admin' %}
            <a class="nav-link {% if request.endpoint == 'orders_new' or request.endpoint == 'monitoring' %}active{% endif %}" href="{{ url_for('orders_new') }}" onclick="loadPage(event, '{{ url_for('orders_new') }}', 'Pesanan Saya')">
                <i class="fas fa-shopping-cart"></i> Pesanan Saya
            </a>
            <div class="nav-item dropdown-menu-item">
                <a class="nav-link {% if request.endpoint == 'orders_toko' or request.endpoint == 'stores_management' or request.endpoint == 'store_orders' %}active{% endif %}" href="#" onclick="toggleDropdown(event, 'storeDropdown')">
                    <span><i class="fas fa-store"></i> Daftar Pesanan Toko</span>
                    <i class="fas fa-chevron-right dropdown-arrow" id="storeArrow"></i>
                </a>
                <div class="dropdown-submenu" id="storeDropdown" style="display: none;">
                    <a class="nav-link submenu-item" href="/stores/management" onclick="loadPage(event, '/stores/management', 'Daftar Toko')">
                        <i class="fas fa-list"></i> Daftar Toko
                    </a>
                    {% for store in active_stores %}
                    <a class="nav-link submenu-item" href="/store/{{ store.sku_code }}" onclick="loadPage(event, '/store/{{ store.sku_code }}', '{{ store.store_name }}')">
                        <i class="fas fa-shop"></i> {{ store.store_name }}
                    </a>
                    {% endfor %}
                </div>
            </div>
            <a class="nav-link {% if request.endpoint == 'warehouse' %}active{% endif %}" href="{{ url_for('warehouse') }}" onclick="loadPage(event, '{{ url_for('warehouse') }}', 'Produk Saya')">
                <i class="fas fa-box"></i> Produk Saya
            </a>
            <a class="nav-link {% if request.endpoint == 'profit_analytics' %}active{% endif %}" href="{{ url_for('profit_analytics') }}" onclick="loadPage(event, '{{ url_for('profit_analytics') }}', 'Keuangan')">
                <i class="fas fa-chart-pie"></i> Keuangan
            </a>
            <a class="nav-link {% if request.endpoint == 'profit_tracker' %}active{% endif %}" href="{{ url_for('profit_tracker') }}" onclick="loadPage(event, '{{ url_for('profit_tracker') }}', 'Analisis Keuntungan')">
                <i class="fas fa-chart-line"></i> Analisis Keuntungan
            </a>
            
            <!-- Location-Based Expense Management -->
            <a class="nav-link {% if request.endpoint == 'expense_management_dashboard' %}active{% endif %}" href="{{ url_for('expense_management_dashboard') }}">
                <i class="fas fa-wallet" style="color: #e67e22;"></i> Management
            </a>
            

            
            
            <a class="nav-link {% if request.endpoint == 'user_management' %}active{% endif %}" href="{{ url_for('user_management') }}" onclick="loadPage(event, '{{ url_for('user_management') }}', 'Management User')">
                <i class="fas fa-cogs"></i> Management User
            </a>
            <a class="nav-link {% if request.endpoint == 'work_schedule_management' %}active{% endif %}" href="/work_schedule_management" onclick="loadPage(event, '/work_schedule_management_content', 'Pengaturan Jam Kerja')">
                <i class="fas fa-clock"></i> Pengaturan Jam Kerja
            </a>
            <a class="nav-link {% if request.endpoint == 'tracking_activities' %}active{% endif %}" href="{{ url_for('tracking_activities') }}" onclick="loadPage(event, '{{ url_for('tracking_activities') }}', 'Tracking Aktivitas')">
                <i class="fas fa-search-location"></i> Tracking Aktivitas
            </a>
            <a class="nav-link {% if request.endpoint == 'approval_requests' %}active{% endif %}" href="{{ url_for('approval_requests') }}" onclick="loadPage(event, '{{ url_for('approval_requests') }}', 'Approval Requests')">
                <i class="fas fa-clipboard-check"></i> Approval Requests
            </a>
            {% endif %}
            
            <!-- Scan Center - Available for all working roles -->
            <!-- Special case: tonidede1 only gets Picking Mode -->
            {% if session.username == 'tonidede1' %}
            <a class="nav-link {% if request.endpoint == 'picking_mode' %}active{% endif %}" href="{{ url_for('picking_mode') }}">
                <i class="fas fa-box-open"></i> Picking Mode
            </a>
            <!-- Special case: scan retur users only get Scan Retur + Foto -->
            {% elif session.get('user_role') == 'scan retur' %}
            <a class="nav-link {% if request.endpoint == 'scan_retur_foto' %}active{% endif %}" href="{{ url_for('scan_retur_foto') }}">
                <i class="fas fa-camera-retro"></i> Scan Retur + Foto
            </a>
            {% elif 'admin' in session.get('user_role', '') or 'picker' in session.get('user_role', '') or 'packer' in session.get('user_role', '') or 'shipper' in session.get('user_role', '') %}
            <div class="nav-item dropdown-menu-item">
                <a class="nav-link {% if request.endpoint == 'scan_center' %}active{% endif %}" href="#" onclick="toggleDropdown(event, 'scanCenterDropdown')">
                    <span><i class="fas fa-qrcode"></i> Scan Center</span>
                    <i class="fas fa-chevron-right dropdown-arrow" id="scanCenterArrow"></i>
                </a>
                <div class="dropdown-submenu" id="scanCenterDropdown" style="display: none;">
                    <!-- Picker: Only Picking Mode -->
                    {% if 'picker' in session.get('user_role', '') %}
                    <a class="nav-link submenu-item" href="{{ url_for('picking_mode') }}">
                        <i class="fas fa-box-open"></i> Picking Mode
                    </a>
                    {% endif %}
                    
                    <!-- Packer: Only Packing Mode -->
                    {% if 'packer' in session.get('user_role', '') %}
                    <a class="nav-link submenu-item" href="{{ url_for('packing_mode') }}">
                        <i class="fas fa-box"></i> Validasi Packing
                    </a>
                    {% endif %}
                    
                    <!-- Shipper: Only Ready Pickup Mode -->
                    {% if 'shipper' in session.get('user_role', '') %}
                    <a class="nav-link submenu-item" href="{{ url_for('ready_pickup_mode') }}">
                        <i class="fas fa-truck"></i> Ready Pick Up
                    </a>
                    {% endif %}
                    
                    <!-- Admin: All modes -->
                    {% if 'admin' in session.get('user_role', '') %}
                    <a class="nav-link submenu-item" href="{{ url_for('picking_mode') }}">
                        <i class="fas fa-box-open"></i> Picking Mode
                    </a>
                    <a class="nav-link submenu-item" href="{{ url_for('packing_mode') }}">
                        <i class="fas fa-box"></i> Validasi Packing
                    </a>
                    <a class="nav-link submenu-item" href="{{ url_for('ready_pickup_mode') }}">
                        <i class="fas fa-truck"></i> Ready Pick Up
                    </a>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            
            <!-- Scan Retur + Foto - Admin and Scan Retur users -->
            {% if session.user_role == 'admin' %}
            <a class="nav-link {% if request.endpoint == 'scan_retur_foto' %}active{% endif %}" href="{{ url_for('scan_retur_foto') }}">
                <i class="fas fa-camera-retro"></i> Scan Retur + Foto
            </a>
            {% endif %}
            
            <!-- Logout Button - Available for all users -->
            <div class="mt-auto pt-3" style="border-top: 1px solid rgba(255,255,255,0.1);">
                <a class="nav-link" href="{{ url_for('logout') }}" onclick="return confirm('Yakin ingin logout?')">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </nav>
    </div>

    <div class="main-content">
        {% block content %}{% endblock %}
    </div>

    <!-- 10x ULTRA: Critical JavaScript inline for instant interactivity -->
    <script>
        // 10x ULTRA: Performance-optimized DOM ready
        document.addEventListener('DOMContentLoaded',function(){
            var l=document.querySelectorAll('.loading');
            l.forEach(function(e){e.style.display='none'});
            
            // 10x ULTRA: DOM element cache for ultra-fast access
            window.domCache={};
            window.getCachedElement=function(s){
                if(!window.domCache[s]){
                    window.domCache[s]=document.querySelector(s);
                }
                return window.domCache[s];
            };
        });
        
        // 10x ULTRA: Optimized AJAX function with caching
        window.ultraAjax=function(url,callback,errorCallback){
            var x=new XMLHttpRequest();
            x.open('GET',url,true);
            x.setRequestHeader('X-Requested-With','XMLHttpRequest');
            x.timeout=3000; // Ultra-fast 3s timeout
            x.onreadystatechange=function(){
                if(x.readyState===4){
                    if(x.status===200){
                        callback(x.responseText);
                    }else if(errorCallback){
                        errorCallback(x.status);
                    }
                }
            };
            x.send();
        };
    </script>
    
    <!-- 10x ULTRA: Async Bootstrap loading with error handling -->
    <script>
        (function(){
            var s=document.createElement('script');
            s.src='https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js';
            s.async=true;
            s.crossOrigin='anonymous';
            s.onerror=function(){console.warn('Bootstrap failed to load')};
            document.head.appendChild(s);
        })();
    </script>
    
    <script>
    // Global dropdown toggle function
    function toggleDropdown(event, dropdownId) {
        event.preventDefault();
        event.stopPropagation();
        
        const dropdown = document.getElementById(dropdownId);
        const arrow = document.getElementById(dropdownId.replace('Dropdown', 'Arrow'));
        
        if (dropdown.style.display === 'none' || dropdown.style.display === '') {
            dropdown.style.display = 'block';
            arrow.classList.add('rotated');
        } else {
            dropdown.style.display = 'none';
            arrow.classList.remove('rotated');
        }
    }
    
    // Auto-expand dropdown if on scan center page
    document.addEventListener('DOMContentLoaded', function() {
        const currentPath = window.location.pathname;
        if (currentPath.includes('scan_center') || currentPath.includes('scan')) {
            const dropdown = document.getElementById('scanCenterDropdown');
            const arrow = document.getElementById('scanCenterArrow');
            if (dropdown && arrow) {
                dropdown.style.display = 'block';
                arrow.classList.add('rotated');
            }
        }
    });
    
    // Global warehouse modal functions - available on all pages
    let currentProductId = null;
    
    window.showQuantityModal = function(productId, productName, currentQuantity) {
        currentProductId = productId;
        document.getElementById('quantityProductName').textContent = productName;
        document.getElementById('newQuantity').value = currentQuantity;
        
        const modal = new bootstrap.Modal(document.getElementById('quantityModal'));
        modal.show();
    };
    
    window.showPriceModal = function(productId, productName, currentPrice) {
        currentProductId = productId;
        document.getElementById('priceProductName').textContent = productName;
        document.getElementById('newPrice').value = currentPrice;
        
        const modal = new bootstrap.Modal(document.getElementById('priceModal'));
        modal.show();
    };
    
    window.showLocationModal = function(productId, productName, zone, rack, bin) {
        document.getElementById('locationProductId').value = productId;
        document.getElementById('locationProductName').textContent = productName;
        document.getElementById('locationZone').value = zone || '';
        document.getElementById('locationRack').value = rack || '';
        document.getElementById('locationBin').value = bin || '';
        
        const modal = new bootstrap.Modal(document.getElementById('locationModal'));
        modal.show();
    };
    
    window.showSkuModal = function(productId, productName, currentSku) {
        currentProductId = productId;
        document.getElementById('skuProductName').textContent = productName;
        document.getElementById('newSku').value = currentSku;
        
        const modal = new bootstrap.Modal(document.getElementById('skuModal'));
        modal.show();
    };
    
    window.updateQuantityFromModal = function() {
        const newQuantity = document.getElementById('newQuantity').value;
        
        if (!currentProductId || !newQuantity || newQuantity < 0) {
            alert('Please enter a valid quantity');
            return;
        }
        
        fetch(`/warehouse/${currentProductId}/update_quantity`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                quantity: parseInt(newQuantity)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Close modal
                var quantityModal = bootstrap.Modal.getInstance(document.getElementById('quantityModal'));
                quantityModal.hide();
                
                // Update quantity display in the table without reload
                const rows = document.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const editIcon = row.querySelector(`[onclick*="showQuantityModal(${currentProductId}"]`);
                    if (editIcon) {
                        const quantityDisplay = row.querySelector('.quantity-display');
                        if (quantityDisplay) {
                            quantityDisplay.textContent = newQuantity;
                        }
                    }
                });
                
                // Success - no popup needed
            } else {
                alert('Error updating quantity: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Terjadi kesalahan saat mengupdate quantity');
        });
    };
    
    // HR Employee Management functions
    window.showAddEmployeeModal = function() {
        const modal = new bootstrap.Modal(document.getElementById('addEmployeeModal'));
        modal.show();
    };
    
    // Simplified form submission - no AJAX needed
    window.submitAddEmployee = function(event) {
        // Let the form submit normally
        return true;
    };
    
    // Edit Employee Modal functionality - FIXED ENDPOINT
    window.editEmployee = function(employeeId) {
        console.log('🚀 BASE SIDEBAR editEmployee called - Employee ID:', employeeId);
        
        // Use correct endpoint with credentials
        fetch(`/employee_management/get/${employeeId}`, {
            method: 'GET',
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => {
                console.log('🌐 BASE - Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('📨 BASE - Data received:', data);
                if (data.success) {
                    const employee = data.employee;
                    
                    console.log('✅ BASE - Populating edit modal with employee:', employee);
                    
                    // Populate modal fields with correct field IDs
                    document.getElementById('editEmployeeIdField').value = employee.id;
                    document.getElementById('editEmployeeId').value = employee.employee_id;
                    document.getElementById('editFullName').value = employee.full_name || '';
                    document.getElementById('editPosition').value = employee.position || '';
                    document.getElementById('editBranchLocation').value = employee.branch_location || '';
                    
                    // Filter salary groups based on location first, then set value
                    if (typeof filterEditSalaryGroups === 'function') {
                        filterEditSalaryGroups();
                    }
                    document.getElementById('editSalaryGroup').value = employee.salary_group_id || '';
                    
                    console.log('✅ BASE - All fields populated:', {
                        id: employee.id,
                        employee_id: employee.employee_id,
                        full_name: employee.full_name,
                        position: employee.position,
                        branch_location: employee.branch_location,
                        salary_group_id: employee.salary_group_id
                    });
                    
                    // Show modal with Bootstrap 5 syntax
                    const modal = new bootstrap.Modal(document.getElementById('editEmployeeModal'));
                    modal.show();
                    
                    console.log('✅ BASE - Edit modal opened successfully');
                } else {
                    console.error('❌ BASE - Server error:', data);
                    alert('Gagal memuat data karyawan: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('❌ BASE - Fetch error:', error);
                alert('Terjadi kesalahan saat memuat data karyawan: ' + error.message);
            });
    };
    
    window.toggleEmployeeStatus = function(employeeId, currentStatus) {
        const action = currentStatus ? 'menonaktifkan' : 'mengaktifkan';
        if (confirm(`Yakin ingin ${action} karyawan ini?`)) {
            // Simple form submission
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/employee_management/${employeeId}/toggle_status`;
            
            const statusInput = document.createElement('input');
            statusInput.type = 'hidden';
            statusInput.name = 'is_active';
            statusInput.value = !currentStatus;
            form.appendChild(statusInput);
            
            document.body.appendChild(form);
            form.submit();
        }
    };
    
    window.viewAttendance = function(employeeId) {
        window.open(`/attendance/history/${employeeId}`, '_blank');
    };
    
    window.startAttendance = function(employeeId) {
        window.location.href = `/attendance?employee=${employeeId}`;
    };
    
    // Employee checkbox management functions
    window.toggleAllEmployees = function() {
        const selectAllCheckbox = document.getElementById('selectAllEmployees');
        const employeeCheckboxes = document.querySelectorAll('.employee-checkbox');
        
        employeeCheckboxes.forEach(checkbox => {
            checkbox.checked = selectAllCheckbox.checked;
        });
        
        updateDeleteButton();
    };
    
    window.updateDeleteButton = function() {
        const selectedCheckboxes = document.querySelectorAll('.employee-checkbox:checked');
        const deleteButton = document.getElementById('deleteSelectedEmployees');
        
        if (selectedCheckboxes.length > 0) {
            deleteButton.style.display = 'inline-block';
        } else {
            deleteButton.style.display = 'none';
        }
        
        // Update select all checkbox state
        const selectAllCheckbox = document.getElementById('selectAllEmployees');
        const allCheckboxes = document.querySelectorAll('.employee-checkbox');
        const checkedCount = document.querySelectorAll('.employee-checkbox:checked').length;
        
        if (checkedCount === 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        } else if (checkedCount === allCheckboxes.length) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
        } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = true;
        }
    };
    
    window.deleteSelectedEmployees = function() {
        const selectedCheckboxes = document.querySelectorAll('.employee-checkbox:checked');
        const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.getAttribute('data-id'));
        
        if (selectedIds.length === 0) {
            alert('Pilih karyawan yang ingin dihapus terlebih dahulu');
            return;
        }
        
        const confirmMessage = `Yakin ingin menghapus ${selectedIds.length} karyawan terpilih? Tindakan ini tidak dapat dibatalkan.`;
        if (confirm(confirmMessage)) {
            // Show loading state
            const deleteButton = document.getElementById('deleteSelectedEmployees');
            const originalText = deleteButton.innerHTML;
            deleteButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Menghapus...';
            deleteButton.disabled = true;
            
            fetch('/employee_management/delete_selected', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin',
                body: JSON.stringify({
                    employee_ids: selectedIds
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Refresh current branch filter
                    const branch = document.getElementById('branchFilter').value;
                    filterByBranch();
                    
                    alert(`Berhasil menghapus ${data.deleted_count} karyawan`);
                } else {
                    alert('Gagal menghapus karyawan: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Terjadi kesalahan saat menghapus karyawan');
            })
            .finally(() => {
                // Restore button state
                deleteButton.innerHTML = originalText;
                deleteButton.disabled = false;
            });
        }
    };
    
    window.updatePriceFromModal = function() {
        const newPrice = document.getElementById('newPrice').value;
        
        if (!currentProductId || !newPrice || newPrice < 0) {
            alert('Please enter a valid price');
            return;
        }
        
        fetch(`/warehouse/${currentProductId}/update_price`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                price: parseInt(newPrice)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Close modal
                var priceModal = bootstrap.Modal.getInstance(document.getElementById('priceModal'));
                priceModal.hide();
                
                // Update price display in the table without reload
                const rows = document.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const editIcon = row.querySelector(`[onclick*="showPriceModal(${currentProductId}"]`);
                    if (editIcon) {
                        const priceDisplay = row.querySelector('.price-display');
                        if (priceDisplay) {
                            priceDisplay.textContent = 'Rp' + newPrice;
                        }
                    }
                });
                
                // Success - no popup needed
            } else {
                alert('Error updating price: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Terjadi kesalahan saat mengupdate harga');
        });
    };
    
    window.updateLocation = function() {
        const productId = document.getElementById('locationProductId').value;
        const zone = document.getElementById('locationZone').value.trim();
        const rack = document.getElementById('locationRack').value.trim();
        const bin = document.getElementById('locationBin').value.trim();
        
        fetch(`/warehouse/${productId}/update_location`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                zone: zone,
                rack: rack,
                bin: bin
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('locationModal'));
                modal.hide();
                
                // Update display without reload
                const row = document.querySelector(`tr:has(.product-checkbox[data-id="${productId}"])`);
                if (row) {
                    const locationCell = row.querySelector('.location-display');
                    if (zone || rack || bin) {
                        const locationParts = [zone, rack, bin].filter(part => part).join('-');
                        locationCell.innerHTML = `<span class="badge bg-secondary">${locationParts}</span>`;
                    } else {
                        locationCell.innerHTML = '<span class="text-muted">-</span>';
                    }
                }
                
                // Success - no popup needed
            } else {
                alert('Error updating location: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Terjadi kesalahan saat mengupdate lokasi');
        });
    };
    
    window.updateSkuFromModal = function() {
        const newSku = document.getElementById('newSku').value.trim();
        
        if (!currentProductId || !newSku) {
            alert('Please enter a valid SKU');
            return;
        }
        
        fetch(`/warehouse/${currentProductId}/update_sku`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                sku: newSku
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('skuModal'));
                modal.hide();
                
                // Update SKU display in the table without reload
                const rows = document.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const editIcon = row.querySelector(`[onclick*="showSkuModal(${currentProductId}"]`);
                    if (editIcon) {
                        const skuDisplay = row.querySelector('.sku-display');
                        if (skuDisplay) {
                            skuDisplay.textContent = newSku;
                        }
                    }
                });
                
                // Success - no popup needed
            } else {
                alert('Error updating SKU: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Terjadi kesalahan saat mengupdate SKU');
        });
    };

    // Global warehouse functions - available on all pages
    window.printSelectedQR = function() {
        const selectedProducts = [];
        document.querySelectorAll('.product-checkbox:checked').forEach(checkbox => {
            selectedProducts.push(checkbox.getAttribute('data-id'));
        });
        
        if (selectedProducts.length === 0) {
            alert('Silakan pilih minimal satu produk');
            return;
        }
        
        // Open all QR codes in one page for easy printing
        const ids = selectedProducts.join(',');
        window.open(`/qr-codes-multiple?ids=${ids}`, '_blank');
    };
    
    // Global user management functions - available on all pages
    window.updateUsername = function(userId) {
        const usernameInput = document.getElementById(`username_${userId}`);
        const newUsername = usernameInput.value.trim();
        
        if (!newUsername) {
            alert('Username tidak boleh kosong!');
            return;
        }
        
        fetch('/update_username', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                user_id: userId,
                username: newUsername
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Username updated successfully');
            } else {
                alert('Error: ' + data.message);
                // Revert to original value on error
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Terjadi kesalahan saat mengupdate username');
            location.reload();
        });
    };
    
    window.changePassword = function(userId, username) {
        const newPassword = prompt(`Masukkan password baru untuk user "${username}":`);
        
        if (!newPassword) {
            return; // User cancelled
        }
        
        if (newPassword.length < 6) {
            alert('Password harus minimal 6 karakter!');
            return;
        }
        
        if (confirm(`Yakin ingin mengubah password untuk user "${username}"?`)) {
            fetch('/change_password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    user_id: userId,
                    new_password: newPassword
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Password untuk user "${username}" berhasil diubah!`);
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Terjadi kesalahan saat mengubah password');
            });
        }
    };
    
    // Add global function for branch filtering (AJAX)
    window.filterByBranch = function() {
        const branch = document.getElementById('branchFilter').value;
        console.log(`Starting filter for branch: ${branch}`);
        
        // Debug: check if content container exists
        const contentDiv = document.querySelector('.main-content');
        console.log('Content div found:', contentDiv);
        
        // INSTANT: Remove loading delay for immediate response
        
        // Make AJAX request to filter employees by branch
        fetch(`/api/employees_by_branch?branch=${encodeURIComponent(branch)}`, {
            method: 'GET',
            credentials: 'same-origin',  // Include session cookies
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('API Response:', data);
                if (data.success) {
                    // Replace content with new filtered data
                    if (contentDiv) {
                        console.log('Replacing content...');
                        contentDiv.innerHTML = data.html;
                        contentDiv.style.opacity = '1';
                        console.log('Content replaced successfully');
                    } else {
                        console.error('Content div not found!');
                    }
                    
                    // Update page URL without reload
                    const newUrl = `/employee_management?branch=${encodeURIComponent(branch)}`;
                    history.pushState({branch: branch}, '', newUrl);
                    
                    console.log(`Filtered to ${branch} branch: ${data.statistics.employees_count} employees`);
                } else {
                    console.error('Error filtering employees:', data.error);
                    alert('Terjadi kesalahan saat memfilter data karyawan');
                    if (contentDiv) {
                        contentDiv.style.opacity = '1';
                    }
                }
            })
            .catch(error => {
                console.error('Network error:', error);
                alert('Terjadi kesalahan jaringan: ' + error.message);
                if (contentDiv) {
                    contentDiv.style.opacity = '1';
                }
            });
    };
    
    // Add global function for showing add employee modal
    window.showAddEmployeeModal = function() {
        const modal = new bootstrap.Modal(document.getElementById('addEmployeeModal'));
        modal.show();
    };
    
    // Update user name function
    window.updateUserName = function(userId) {
        const nameInput = document.getElementById(`name_${userId}`);
        const newName = nameInput.value.trim();
        
        fetch('/update_user_name', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                user_id: userId,
                name: newName
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('User name updated successfully');
            } else {
                alert('Error: ' + data.message);
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Terjadi kesalahan saat mengupdate nama');
            location.reload();
        });
    };
    
    // Global Work Schedule Save Function - Available for AJAX navigation
    window.saveSchedule = function(branch, scheduleType) {
        const timeInput = document.getElementById(`time_${branch.toLowerCase()}_${scheduleType}`);
        const toleranceInput = document.getElementById(`tolerance_${branch.toLowerCase()}_${scheduleType}`);
        
        if (!timeInput || !timeInput.value) {
            alert('Harap isi jam target terlebih dahulu');
            return;
        }
        
        const targetTime = timeInput.value;
        const toleranceMinutes = parseInt(toleranceInput.value) || 30;
        
        // Show loading
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = 'Menyimpan...';
        button.disabled = true;
        
        // Send data to backend
        fetch('/work_schedule/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                branch_location: branch,
                schedule_type: scheduleType,
                target_time: targetTime,
                tolerance_minutes: toleranceMinutes
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update tolerance window display
                const windowDisplay = document.getElementById(`window_${branch.toLowerCase()}_${scheduleType}`);
                if (windowDisplay) {
                    // Calculate tolerance window
                    const [hours, minutes] = targetTime.split(':').map(Number);
                    const targetDate = new Date();
                    targetDate.setHours(hours, minutes, 0, 0);
                    
                    const startDate = new Date(targetDate.getTime() - (toleranceMinutes * 60000));
                    const endDate = new Date(targetDate.getTime() + (toleranceMinutes * 60000));
                    
                    const startTime = startDate.toTimeString().substr(0, 5);
                    const endTime = endDate.toTimeString().substr(0, 5);
                    
                    windowDisplay.textContent = `Jendela toleransi: ${startTime} - ${endTime}`;
                }
                alert('Pengaturan berhasil disimpan!');
            } else {
                alert('Gagal menyimpan: ' + (data.error || 'Terjadi kesalahan'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Terjadi kesalahan saat menyimpan');
        })
        .finally(() => {
            // Restore button
            button.textContent = originalText;
            button.disabled = false;
        });
    };
    
    // Update user email function
    window.updateUserEmail = function(userId) {
        const emailInput = document.getElementById(`email_${userId}`);
        const newEmail = emailInput.value.trim();
        
        // Basic email validation
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (newEmail && !emailRegex.test(newEmail)) {
            alert('Format email tidak valid!');
            location.reload();
            return;
        }
        
        fetch('/update_user_email', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                user_id: userId,
                email: newEmail
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('User email updated successfully');
            } else {
                alert('Error: ' + data.message);
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Terjadi kesalahan saat mengupdate email');
            location.reload();
        });
    };
    
    // Update quantity function
    window.updateQuantity = function(productId, newQuantity) {
        fetch(`/warehouse/${productId}/adjust_quantity`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                quantity: parseInt(newQuantity)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                alert('Error updating quantity: ' + data.message);
                location.reload();
            }
        });
    };

    // Advertising History Management Functions
    window.updateDeleteButtonVisibility = function() {
        const checkedBoxes = document.querySelectorAll('.history-checkbox:checked');
        const deleteButton = document.getElementById('deleteSelectedHistoryBtn');
        
        if (deleteButton) {
            if (checkedBoxes.length > 0) {
                deleteButton.style.display = 'inline-block';
                deleteButton.innerHTML = `<i class="fas fa-trash"></i> Delete Selected (${checkedBoxes.length})`;
            } else {
                deleteButton.style.display = 'none';
            }
        }
    };

    window.editAdvertisingCost = function(costId, storeId, expenseDate, currentCost) {
        // Auto-fill form dengan data existing
        const storeSelect = document.getElementById('store_id');
        const dateInput = document.getElementById('cost_date');
        const costInput = document.getElementById('advertising_cost');
        
        if (storeSelect) storeSelect.value = storeId;
        if (dateInput) dateInput.value = expenseDate;
        if (costInput) costInput.value = currentCost;
        
        // Scroll ke form
        if (storeSelect) {
            storeSelect.scrollIntoView({ behavior: 'smooth' });
        }
        
        // Highlight form dengan animation
        const form = document.querySelector('form[action*="profit_tracker_settings"]');
        if (form) {
            form.style.transition = 'all 0.3s ease';
            form.style.backgroundColor = '#fff3cd';
            
            setTimeout(() => {
                form.style.backgroundColor = '';
            }, 2000);
        }
        
        // Fokus ke input biaya iklan
        setTimeout(() => {
            if (costInput) {
                costInput.focus();
                costInput.select();
            }
        }, 500);
    };
    
    // Update price function
    window.updatePrice = function(productId, newPrice) {
        fetch(`/warehouse/adjust_price/${productId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                price: parseFloat(newPrice)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                alert('Error updating price: ' + data.message);
                location.reload();
            }
        });
    };
    
    // Delete product function
    window.deleteProduct = function(productId, productName) {
        if (confirm(`Yakin ingin menghapus produk "${productName}"?`)) {
            fetch(`/warehouse/${productId}/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Produk berhasil dihapus');
                    location.reload();
                } else {
                    alert('Error menghapus produk: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Terjadi kesalahan saat menghapus produk');
            });
        }
    };
    
    // Delete selected products function
    window.deleteSelectedProducts = function() {
        const selectedProducts = [];
        document.querySelectorAll('.product-checkbox:checked').forEach(checkbox => {
            selectedProducts.push(checkbox.getAttribute('data-id'));
        });
        
        if (selectedProducts.length === 0) {
            alert('Silakan pilih produk yang ingin dihapus');
            return;
        }
        
        if (confirm(`Yakin ingin menghapus ${selectedProducts.length} produk terpilih?`)) {
            fetch('/warehouse/delete_selected', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    product_ids: selectedProducts
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Berhasil menghapus ${data.deleted_count} produk`);
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Terjadi kesalahan saat menghapus produk');
            });
        }
    };
    
    // Delete all orders function
    window.deleteAllOrders = function() {
        if (confirm('Apakah Anda yakin ingin menghapus SEMUA pesanan? Aksi ini tidak dapat dibatalkan!')) {
            fetch('/orders/delete_all', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Semua pesanan berhasil dihapus');
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Terjadi kesalahan saat menghapus pesanan');
            });
        }
    };
    
    // Switch store function for orders_toko page
    window.switchStore = function(store) {
        console.log('Store tab clicked, navigating to store:', store);
        
        // Update active store tab state immediately
        document.querySelectorAll('.store-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Add active class to clicked store tab
        const clickedTab = document.querySelector(`[data-store="${store}"]`);
        if (clickedTab) {
            clickedTab.classList.add('active');
        }
        
        // INSTANT: Get main content without loading delay
        const mainContent = document.querySelector('.main-content');
        
        // Get current status filter if available
        const currentStatus = new URLSearchParams(window.location.search).get('status') || 'all';
        
        // Construct URL with store and status parameters
        const baseUrl = '/orders/toko';
        const url = `${baseUrl}?store=${store}&status=${currentStatus}&ajax=1`;
        
        // Update dropdown selection if exists
        const storeSelector = document.getElementById('storeSelector');
        if (storeSelector) {
            storeSelector.value = store;
        }
        
        // Make AJAX request to load orders by store
        fetch(url, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.text())
        .then(html => {
            if (mainContent) {
                // INSTANT: Update content immediately
                mainContent.innerHTML = html;
                
                // INSTANT: Update URL immediately
                const newUrl = `${baseUrl}?store=${store}&status=${currentStatus}`;
                window.history.replaceState({}, '', newUrl);
                
                // INSTANT: Re-initialize event listeners
                initializeTabEventListeners();
            }
        })
        .catch(error => {
            console.error('Store switch error:', error);
            // Fallback to normal navigation
            window.location.href = url.replace('&ajax=1', '');
        });
    };

    // Switch tab function for orders with proper event delegation
    window.switchTab = function(status) {
        console.log('Tab clicked, navigating to status:', status);
        
        // Update active tab state immediately
        document.querySelectorAll('.status-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Add active class to clicked tab
        const clickedTab = document.querySelector(`[data-status="${status}"]`);
        if (clickedTab) {
            clickedTab.classList.add('active');
        }
        
        // INSTANT: Get main content without loading indicator delay
        const mainContent = document.querySelector('.main-content');
        
        // Construct URL with status parameter - use correct route path
        const baseUrl = '/orders/new';
        const url = status === 'all' ? `${baseUrl}?ajax=1` : `${baseUrl}?status=${status}&ajax=1`;
        
        // Make AJAX request to load orders by status with content-only template
        fetch(url, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.text())
        .then(html => {
            if (mainContent) {
                // INSTANT: Update content immediately
                mainContent.innerHTML = html;
                
                // INSTANT: Re-initialize checkboxes and other functionality
                if (window.initializeCheckboxes) {
                    window.initializeCheckboxes();
                }
                
                // INSTANT: Re-initialize tab event listeners
                initializeTabEventListeners();
                
                // INSTANT: Re-initialize any other JavaScript functionality
                if (typeof initializePageFunctions === 'function') {
                    initializePageFunctions();
                }
            }
        })
        .catch(error => {
            console.error('Tab switch error:', error);
            // Fallback to normal navigation
            window.location.href = url;
        });
    };
    
    // Initialize tab event listeners with proper delegation
    function initializeTabEventListeners() {
        // Remove any existing listeners first to prevent duplicates
        document.removeEventListener('click', handleTabClick);
        
        // Add event delegation for tab clicks
        document.addEventListener('click', handleTabClick);
    }
    
    // Handle tab clicks with event delegation
    function handleTabClick(event) {
        // Handle status tab clicks
        if (event.target.closest('.status-tab')) {
            event.preventDefault();
            event.stopPropagation();
            
            const tab = event.target.closest('.status-tab');
            const status = tab.getAttribute('data-status');
            
            if (status) {
                console.log('Status tab clicked via delegation:', status);
                // Check if we're on orders_toko page
                if (window.location.pathname.includes('/orders/toko')) {
                    switchTokoStatus(status);
                } else {
                    switchTab(status);
                }
            }
        }
        
        // Handle store tab clicks for orders_toko page
        if (event.target.closest('.store-tab')) {
            event.preventDefault();
            event.stopPropagation();
            
            const tab = event.target.closest('.store-tab');
            const store = tab.getAttribute('data-store');
            
            if (store) {
                console.log('Store tab clicked via delegation:', store);
                switchStore(store);
            }
        }
    }
    
    // Switch status function specifically for orders_toko page
    window.switchTokoStatus = function(status) {
        console.log('Toko status tab clicked, navigating to status:', status);
        
        // Update active status tab state immediately
        document.querySelectorAll('.status-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Add active class to clicked status tab
        const clickedTab = document.querySelector(`[data-status="${status}"]`);
        if (clickedTab) {
            clickedTab.classList.add('active');
        }
        
        // INSTANT: Get main content without loading delays
        const mainContent = document.querySelector('.main-content');
        
        // Get current store filter
        const currentStore = new URLSearchParams(window.location.search).get('store') || 'MJP';
        
        // Construct URL with store and status parameters
        const baseUrl = '/orders/toko';
        const url = `${baseUrl}?store=${currentStore}&status=${status}&ajax=1`;
        
        // Make AJAX request to load orders by status
        fetch(url, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.text())
        .then(html => {
            if (mainContent) {
                // INSTANT: Update content immediately
                mainContent.innerHTML = html;
                
                // INSTANT: Update URL immediately
                const newUrl = `${baseUrl}?store=${currentStore}&status=${status}`;
                window.history.replaceState({}, '', newUrl);
                
                // INSTANT: Re-initialize event listeners
                initializeTabEventListeners();
            }
        })
        .catch(error => {
            console.error('Toko status switch error:', error);
            // Fallback to normal navigation
            window.location.href = url.replace('&ajax=1', '');
        });
    };
    
    // Initialize tab event listeners on page load
    document.addEventListener('DOMContentLoaded', function() {
        initializeTabEventListeners();
        // console.log('Orders page loaded successfully with event delegation');
    });
    
    // Store orders tab switching function
    window.switchStoreTab = function(storeCode, status) {
        console.log('switchStoreTab called:', storeCode, status);
        
        // INSTANT: Get main content without any loading delays
        const mainContent = document.querySelector('.main-content');
        
        // Construct URL with store and status parameters (reset to page 1 when switching tabs)
        const baseUrl = `/store/${storeCode}`;
        const url = `${baseUrl}?status=${status}&page=1&ajax=1`;
        
        console.log('Fetching URL:', url);
        
        // Make AJAX request to load orders by status for this store
        fetch(url, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            console.log('Response received:', response.status);
            return response.text();
        })
        .then(html => {
            console.log('HTML received, updating content');
            if (mainContent) {
                // INSTANT: Update content immediately
                mainContent.innerHTML = html;
                
                // INSTANT: Update URL immediately
                const newUrl = `${baseUrl}?status=${status}&page=1`;
                window.history.replaceState({}, '', newUrl);
                
                console.log('Content updated successfully');
            }
        })
        .catch(error => {
            console.error('Store tab switch error:', error);
            // Fallback to normal navigation
            window.location.href = url.replace('&ajax=1', '');
        });
    };

    // Store tab switching function with pagination
    window.switchStoreTabWithPage = function(storeCode, status, page) {
        console.log('switchStoreTabWithPage called:', storeCode, status, page);
        
        // INSTANT: Get main content without loading delay
        const mainContent = document.querySelector('.main-content');
        
        // Construct URL with store, status, and page parameters
        const baseUrl = `/store/${storeCode}`;
        const url = `${baseUrl}?status=${status}&page=${page}&ajax=1`;
        
        console.log('Fetching URL:', url);
        
        // Make AJAX request to load orders by status and page for this store
        fetch(url, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            console.log('Response received:', response.status);
            return response.text();
        })
        .then(html => {
            console.log('HTML received, updating content');
            if (mainContent) {
                // INSTANT: Update content immediately
                mainContent.innerHTML = html;
                
                // INSTANT: Update URL immediately  
                const newUrl = `${baseUrl}?status=${status}&page=${page}`;
                window.history.replaceState({}, '', newUrl);
                
                console.log('Content updated successfully');
            }
        })
        .catch(error => {
            console.error('Store pagination switch error:', error);
            // Fallback to normal navigation
            window.location.href = url.replace('&ajax=1', '');
        });
    };
    
    // Store management functions
    window.editStore = function(storeId) {
        alert('Fitur edit toko akan segera tersedia');
    };

    window.deleteStore = function(storeId, storeName) {
        if (confirm(`Yakin ingin menghapus toko "${storeName}"?`)) {
            alert('Fitur delete toko akan segera tersedia');
        }
    };
    
    // Global scan center functions - available on all pages
    window.toggleScanMenu = function() {
        const menu = document.getElementById('scanMenu');
        const icon = document.getElementById('menuIcon');
        
        if (menu && icon) {
            if (menu.style.display === 'none' || menu.style.display === '') {
                menu.style.display = 'block';
                icon.classList.add('fa-chevron-up');
                icon.classList.remove('fa-chevron-down');
            } else {
                menu.style.display = 'none';
                icon.classList.add('fa-chevron-down');
                icon.classList.remove('fa-chevron-up');
            }
        }
    };
    
    window.switchScanMode = function(mode) {
        const menu = document.getElementById('scanMenu');
        const icon = document.getElementById('menuIcon');
        
        // Hide menu after selection
        if (menu && icon) {
            menu.style.display = 'none';
            icon.classList.add('fa-chevron-down');
            icon.classList.remove('fa-chevron-up');
        }
        
        // Load scan interface for selected mode
        loadScanInterface(mode);
    };
    
    // Global loadScanInterface function
    window.loadScanInterface = function(mode) {
        const scanInterface = document.getElementById('scanInterface');
        if (!scanInterface) return;
        
        let modeTitle = '';
        let modeContent = '';
        let buttonClass = '';
        
        switch(mode) {
            case 'picking':
                modeTitle = 'Mode Picking';
                buttonClass = 'picking';
                modeContent = `
                    <div class="clean-input-group">
                        <label>Scan Order ID atau Tracking Number:</label>
                        <input type="text" id="pickingInput" placeholder="Scan atau ketik disini..." autofocus>
                        <button class="clean-scan-btn ${buttonClass}" onclick="processPicking()">Proses Picking</button>
                    </div>
                `;
                break;
            case 'packing':
                modeTitle = 'Mode Validasi Packing';
                buttonClass = 'packing';
                modeContent = `
                    <div class="clean-input-group">
                        <label>Scan Order ID atau Tracking Number:</label>
                        <input type="text" id="packingInput" placeholder="Scan atau ketik disini..." autofocus>
                        <button class="clean-scan-btn ${buttonClass}" onclick="processPacking()">Validasi Packing</button>
                    </div>
                `;
                break;
            case 'pickup':
                modeTitle = 'Mode Ready Pick Up';
                buttonClass = 'pickup';
                modeContent = `
                    <div class="clean-input-group">
                        <label>Scan Tracking Number:</label>
                        <input type="text" id="pickupInput" placeholder="Scan atau ketik disini..." autofocus>
                        <button class="clean-scan-btn ${buttonClass}" onclick="processPickup()">Ready Pick Up</button>
                    </div>
                `;
                break;
        }
        
        scanInterface.innerHTML = `
            <div class="clean-mode-title">${modeTitle}</div>
            ${modeContent}
        `;
        
        // Focus on input after loading
        setTimeout(() => {
            const input = scanInterface.querySelector('input[type="text"]');
            if (input) input.focus();
        }, 100);
    };
    
    // Global processing functions
    window.processPicking = function() {
        const input = document.getElementById('pickingInput');
        if (!input || !input.value) {
            alert('Silakan masukkan Order ID atau Tracking Number');
            return;
        }
        
        // Stay in current page if already in picking mode
        if (window.location.pathname === '/picking-mode') {
            // Use existing picking function
            document.getElementById('pickingOrderInput').value = input.value;
            if (typeof startPickingProcess === 'function') {
                startPickingProcess();
            }
        } else {
            // Redirect to picking page only if not already there
            window.location.href = '/picking/' + input.value;
        }
    };
    
    window.processPacking = function() {
        const input = document.getElementById('packingInput');
        if (!input || !input.value) {
            alert('Silakan masukkan Order ID atau Tracking Number');
            return;
        }
        
        // Stay in current page if already in packing mode
        if (window.location.pathname === '/packing-mode') {
            // Use existing packing function if available
            document.getElementById('packingOrderInput').value = input.value;
            if (typeof startPackingProcess === 'function') {
                startPackingProcess();
            }
        } else {
            // Redirect to packing validation page only if not already there
            window.location.href = '/packing_validation/' + input.value;
        }
    };
    
    window.processPickup = function() {
        const input = document.getElementById('pickupInput');
        if (!input || !input.value) {
            alert('Silakan masukkan Tracking Number');
            return;
        }
        
        // Show processing state
        const button = document.querySelector('button[onclick="processPickup()"]');
        if (button) {
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
        }
        
        // Process ready pickup scan
        fetch('/scan_ready_pickup', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                tracking_number: input.value
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Success: ' + data.message);
                input.value = '';
                
                // Play success sound
                const audio = new Audio('/static/success.wav');
                audio.play().catch(e => console.log('Audio play failed:', e));
            } else {
                alert('Error: ' + data.message);
                
                // Play error sound
                const audio = new Audio('/static/error.wav');
                audio.play().catch(e => console.log('Audio play failed:', e));
            }
        })
        .catch(error => {
            alert('Error processing scan: ' + error);
        })
        .finally(() => {
            // Restore button state
            if (button) {
                button.disabled = false;
                button.innerHTML = 'Ready Pick Up';
            }
        });
    };
    
    // Initialize checkbox functionality with delete button toggle - PROTECTED FROM CONFLICTS
    window.initializeCheckboxes = function() {
        // Only initialize if we're on orders/products page, not employee page
        if (window.location.pathname.includes('employee') || window.location.pathname.includes('hr')) {
            console.log('Skipping orders checkbox init on employee page');
            return; // Don't initialize orders checkbox on employee pages
        }
        
        const selectAllCheckbox = document.getElementById('selectAll');
        const productCheckboxes = document.querySelectorAll('.product-checkbox');
        const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
        
        console.log('Initializing orders checkboxes - Found:', {
            selectAll: selectAllCheckbox,
            productCheckboxes: productCheckboxes.length,
            deleteButton: deleteSelectedBtn
        });
        
        function toggleDeleteButton() {
            const selectedCount = document.querySelectorAll('.product-checkbox:checked').length;
            console.log('Selected count:', selectedCount);
            
            if (deleteSelectedBtn) {
                if (selectedCount > 0) {
                    deleteSelectedBtn.style.display = 'inline-block';
                    console.log('Showing delete button');
                } else {
                    deleteSelectedBtn.style.display = 'none';
                    console.log('Hiding delete button');
                }
            }
        }
        
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function() {
                console.log('Select all clicked, checked:', this.checked);
                productCheckboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
                toggleDeleteButton();
            });
        }
        
        productCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                console.log('Product checkbox changed:', this.getAttribute('data-id'), 'checked:', this.checked);
                
                const allChecked = Array.from(productCheckboxes).every(cb => cb.checked);
                const noneChecked = Array.from(productCheckboxes).every(cb => !cb.checked);
                
                if (selectAllCheckbox) {
                    selectAllCheckbox.checked = allChecked;
                    selectAllCheckbox.indeterminate = !allChecked && !noneChecked;
                }
                
                toggleDeleteButton();
            });
        });
        
        // Initial call to set button state
        toggleDeleteButton();
    }
    
    // ULTRA-FAST AJAX Navigation System
    function loadPage(event, url, title) {
        event.preventDefault();
        
        // INSTANT: Update active menu immediately without delay
        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('active');
        });
        event.target.closest('.nav-link').classList.add('active');
        
        // INSTANT: Get main content without any loading delays
        const mainContent = document.querySelector('.main-content');
        
        // Load page content via AJAX
        fetch(url + '?ajax=1', {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.text())
        .then(html => {
            // INSTANT: Update everything immediately
            history.replaceState({title: title}, title, url);
            document.title = title + ' - Strong Order Management';
            mainContent.innerHTML = html;
            
            // INSTANT: Re-initialize without delays
            if (typeof initializePage === 'function') {
                initializePage();
            }
            
            // INSTANT: Initialize checkboxes for non-employee pages
            if (!window.location.pathname.includes('employee') && !window.location.pathname.includes('hr')) {
                initializeCheckboxes();
            }
        })
        .catch(error => {
            console.error('Error loading page:', error);
            // INSTANT: Fallback without delay
            window.location.href = url;
        });
    }
    
    // Handle browser back/forward buttons
    window.addEventListener('popstate', function(event) {
        location.reload();
    });
    
    // AUTO-GENERATE ID SYSTEM FOR EMPLOYEES - DYNAMIC API VERSION
    window.initializeAutoGenerateId = function() {
        console.log('=== AUTO-GENERATE ID SYSTEM ===');
        
        // Dynamic ID generation using API
        const addEmployeeModal = document.getElementById('addEmployeeModal');
        if (addEmployeeModal) {
            addEmployeeModal.addEventListener('show.bs.modal', function() {
                console.log('Modal opening - Fetching next employee ID...');
                
                // Fetch next ID from API
                fetch('/employee_management/get_next_id')
                    .then(response => response.json())
                    .then(data => {
                        setTimeout(function() {
                            const idField = document.getElementById('employeeId');
                            if (idField) {
                                const nextId = data.success ? data.next_id : 'EMP_001';
                                idField.value = nextId;
                                idField.readOnly = true;
                                idField.style.backgroundColor = '#f8f9fa';
                                idField.style.color = '#6c757d';
                                idField.style.cursor = 'not-allowed';
                                console.log(`✅ ID field set to ${nextId} successfully!`);
                            } else {
                                console.error('❌ employeeId field not found');
                            }
                        }, 100);
                    })
                    .catch(error => {
                        console.error('Error fetching next ID:', error);
                        // Fallback to EMP_001 if API fails
                        setTimeout(function() {
                            const idField = document.getElementById('employeeId');
                            if (idField) {
                                idField.value = 'EMP_001';
                                idField.readOnly = true;
                                idField.style.backgroundColor = '#f8f9fa';
                                idField.style.color = '#6c757d';
                                idField.style.cursor = 'not-allowed';
                                console.log('✅ ID field set to EMP_001 (fallback)');
                            }
                        }, 100);
                    });
            });
        }
    };
    
    // OPTIMIZED: Add missing functions to prevent JavaScript errors
    window.updateDeleteButtonVisibility = window.updateDeleteButtonVisibility || function() {
        // Lightweight implementation to prevent errors
        const deleteButton = document.getElementById('deleteSelected') || document.getElementById('deleteSelectedEmployees');
        const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked:not(#selectAll):not(#selectAllEmployees)');
        
        if (deleteButton) {
            if (checkboxes.length > 0) {
                deleteButton.style.display = 'inline-block';
                if (deleteButton.textContent.includes('Delete Selected')) {
                    deleteButton.innerHTML = `<i class="fas fa-trash me-1"></i>Delete Selected (${checkboxes.length})`;
                }
            } else {
                deleteButton.style.display = 'none';
            }
        }
    };
    
    window.editAdvertisingCost = window.editAdvertisingCost || function(costId) {
        // Placeholder to prevent errors
        console.log('editAdvertisingCost called for ID:', costId);
    };
    
    window.toggleAllHistory = window.toggleAllHistory || function() {
        // Placeholder to prevent errors
        console.log('toggleAllHistory called');
    };
    
    window.deleteSelectedHistory = window.deleteSelectedHistory || function() {
        // Placeholder to prevent errors
        console.log('deleteSelectedHistory called');
    };

    // SUPER OPTIMIZED: Single initialization with performance cache
    let pageInitialized = false;
    let initializationTimeout;
    
    function performInitialization() {
        // Prevent duplicate initialization
        if (pageInitialized) {
            return;
        }
        
        // Clear any existing timeout
        if (initializationTimeout) {
            clearTimeout(initializationTimeout);
        }
        
        // Mark as initialized immediately to prevent race conditions
        pageInitialized = true;
        
        // Optimized path-based initialization
        const isEmployeePage = window.location.pathname.includes('employee') || window.location.pathname.includes('hr');
        
        if (isEmployeePage) {
            // Employee pages only
            console.log('Employee page loaded - ONLY initializing employee functions');
            initializeEmployeeCheckboxes();
            initializeAutoGenerateId();
        } else {
            // Other pages
            console.log('Non-employee page loaded - initializing Orders functions');
            initializeCheckboxes();
        }
    }
    
    // Multiple event listeners for maximum compatibility
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', performInitialization, { once: true });
    } else {
        // Document already loaded
        performInitialization();
    }
    
    // Fallback for window load
    window.addEventListener('load', performInitialization, { once: true });
    
    // EMPLOYEE PAGE ONLY - Isolated checkbox and delete functionality 
    window.initializeEmployeeCheckboxes = function() {
        console.log('=== EMPLOYEE CHECKBOX INIT ===');
        
        const selectAllCheckbox = document.getElementById('selectAllEmployees');
        const employeeCheckboxes = document.querySelectorAll('.employee-checkbox');
        const deleteButton = document.getElementById('deleteSelectedEmployees');
        
        console.log('Employee elements found:', {
            selectAll: selectAllCheckbox,
            checkboxes: employeeCheckboxes.length,
            deleteButton: deleteButton
        });
        
        // This function is now handled in employee_management.html
        // Removed duplicate updateDeleteButtonVisibility to avoid conflicts
        
        // Select all functionality
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function() {
                console.log('Employee select all clicked:', this.checked);
                employeeCheckboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
                // Call the function from employee_management.html if it exists
                if (typeof updateDeleteButtonVisibility === 'function') {
                    updateDeleteButtonVisibility();
                }
            });
        }
        
        // OPTIMIZED: Individual checkbox functionality with throttling
        employeeCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                console.log('Employee checkbox changed:', this.value, 'checked:', this.checked);
                // Throttle function calls to prevent performance issues
                clearTimeout(window.checkboxThrottleTimer);
                window.checkboxThrottleTimer = setTimeout(function() {
                    if (typeof updateDeleteButtonVisibility === 'function') {
                        updateDeleteButtonVisibility();
                    }
                }, 50);
            });
        });
        
        // Delete button functionality
        if (deleteButton) {
            console.log('Adding delete button event listener');
            deleteButton.addEventListener('click', function() {
                console.log('Employee delete button clicked');
                deleteSelectedEmployees();
            });
        }
        
        // Initial call to set button state
        updateDeleteButtonVisibility();
    };
    
    // EMPLOYEE PAGE ONLY - Delete selected employees function
    window.deleteSelectedEmployees = function() {
        console.log('=== DELETE SELECTED EMPLOYEES ===');
        
        const selectedCheckboxes = document.querySelectorAll('.employee-checkbox:checked');
        const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);
        
        console.log('Selected employee IDs:', selectedIds);
        
        if (selectedIds.length === 0) {
            alert('Pilih karyawan yang ingin dihapus terlebih dahulu');
            return;
        }
        
        // Enhanced confirmation message
        const confirmMessage = `Apakah Anda yakin ingin menghapus ${selectedIds.length} karyawan yang dipilih?

CATATAN:
• Karyawan dengan riwayat absensi/gaji akan dinonaktifkan (soft delete)
• Karyawan tanpa riwayat akan dihapus permanent (hard delete)

Lanjutkan proses?`;
        
        if (confirm(confirmMessage)) {
            console.log('User confirmed deletion, sending request...');
            
            // Show loading state
            const deleteButton = document.getElementById('deleteSelectedEmployees');
            if (deleteButton) {
                deleteButton.disabled = true;
                deleteButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Memproses...';
            }
            
            fetch('/employee_management/delete_selected', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin',
                body: JSON.stringify({
                    employee_ids: selectedIds
                })
            })
            .then(response => {
                console.log('Delete response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Delete response data:', data);
                if (data.success || data.deleted_count > 0) {
                    alert(`Berhasil diproses: ${data.message}\n\nDetail:\n• ${data.deleted_count} karyawan diproses\n• ${data.error_count} error`);
                    location.reload();
                } else {
                    alert(`Error: ${data.message}`);
                }
            })
            .catch(error => {
                console.error('Delete error:', error);
                alert('Terjadi kesalahan jaringan: ' + error.message);
            })
            .finally(() => {
                // Reset button state
                if (deleteButton) {
                    deleteButton.disabled = false;
                    deleteButton.innerHTML = '<i class="fas fa-trash me-1"></i>Hapus Terpilih';
                }
            });
        }
    };
    
    // Update user role and access function
    window.updateUserRoleAccess = function(userId) {
        // Collect checked roles
        const roleCheckboxes = [
            'admin', 'picker', 'packer', 'shipper', 
            'scan_retur', 'order_staff'
        ];
        const accessCheckboxes = [
            'pick', 'pack', 'ship', 'retur', 'pesanan', 'all'
        ];
        
        const selectedRoles = [];
        const selectedAccess = [];
        
        // Check for both regular and content IDs 
        roleCheckboxes.forEach(role => {
            const checkbox = document.getElementById(`${role}_${userId}`) || 
                           document.getElementById(`${role}_content_${userId}`);
            if (checkbox && checkbox.checked) {
                if (role === 'scan_retur') {
                    selectedRoles.push('scan retur');
                } else if (role === 'order_staff') {
                    selectedRoles.push('order staff');
                } else {
                    selectedRoles.push(role);
                }
            }
        });
        
        accessCheckboxes.forEach(access => {
            const checkbox = document.getElementById(`${access}_${userId}`) || 
                           document.getElementById(`${access}_content_${userId}`);
            if (checkbox && checkbox.checked) {
                if (access === 'pick') {
                    selectedAccess.push('picking');
                } else if (access === 'pack') {
                    selectedAccess.push('packing');
                } else if (access === 'ship') {
                    selectedAccess.push('shipping');
                } else if (access === 'pesanan') {
                    selectedAccess.push('pesanan');
                } else {
                    selectedAccess.push(access);
                }
            }
        });
        
        // Auto-assign access based on roles if none selected manually
        if (selectedAccess.length === 0 && selectedRoles.length > 0) {
            selectedRoles.forEach(role => {
                if (role === 'picker') selectedAccess.push('picking');
                else if (role === 'packer') selectedAccess.push('packing');
                else if (role === 'shipper') selectedAccess.push('shipping');
                else if (role === 'scan retur') selectedAccess.push('retur');
                else if (role === 'order staff') selectedAccess.push('pesanan');
            });
        }
        
        const roleString = selectedRoles.join(',');
        const accessString = selectedAccess.includes('all') ? 'all' : selectedAccess.join(',');
        
        // Send update request
        fetch('/update_user_role_access', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                user_id: userId,
                role: roleString,
                access: accessString
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('User role/access updated successfully');
            } else {
                alert('Error updating user role/access: ' + data.message);
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Terjadi kesalahan saat mengupdate role/access');
            location.reload();
        });
    };
    
    // Global function to view attendance photos (for QR attendance system)
    window.viewAttendancePhotos = function(attendanceId, employeeName) {
        console.log('Viewing photos for attendance:', attendanceId, employeeName);
        
        // Show modal with photos
        const modalHtml = `
            <div class="modal fade" id="photoModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-images me-2"></i>Foto Absensi - ${employeeName}
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div id="photoContent">
                                <div class="text-center">
                                    <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
                                    <p class="mt-2 text-muted">Memuat foto...</p>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal
        const existingModal = document.getElementById('photoModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Add modal to body
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('photoModal'));
        modal.show();
        
        // Fetch photos
        fetch(`/get_attendance_photos/${attendanceId}`)
            .then(response => response.json())
            .then(data => {
                const photoContent = document.getElementById('photoContent');
                
                if (data.success) {
                    let photosHtml = '<div class="row g-3">';
                    
                    if (data.check_in_photo) {
                        photosHtml += `
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-success text-white">
                                        <i class="fas fa-sign-in-alt me-2"></i>Foto Check-in
                                    </div>
                                    <div class="card-body p-0">
                                        <img src="data:image/jpeg;base64,${data.check_in_photo}" 
                                             class="img-fluid w-100" 
                                             alt="Check-in Photo"
                                             style="max-height: 300px; object-fit: cover; cursor: zoom-in;"
                                             onclick="window.open(this.src, '_blank')">
                                    </div>
                                    <div class="card-footer text-muted">
                                        <small><i class="fas fa-clock me-1"></i>Waktu: ${data.check_in_time || '-'}</small>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    if (data.check_out_photo) {
                        photosHtml += `
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-warning text-white">
                                        <i class="fas fa-sign-out-alt me-2"></i>Foto Check-out
                                    </div>
                                    <div class="card-body p-0">
                                        <img src="data:image/jpeg;base64,${data.check_out_photo}" 
                                             class="img-fluid w-100" 
                                             alt="Check-out Photo"
                                             style="max-height: 300px; object-fit: cover; cursor: zoom-in;"
                                             onclick="window.open(this.src, '_blank')">
                                    </div>
                                    <div class="card-footer text-muted">
                                        <small><i class="fas fa-clock me-1"></i>Waktu: ${data.check_out_time || '-'}</small>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    photosHtml += '</div>';
                    
                    if (!data.check_in_photo && !data.check_out_photo) {
                        photosHtml = `
                            <div class="text-center text-muted p-4">
                                <i class="fas fa-camera-retro fa-3x mb-3"></i>
                                <p class="h5">Tidak ada foto tersimpan</p>
                                <p>Tidak ada foto selfie untuk absensi ini</p>
                            </div>
                        `;
                    }
                    
                    photoContent.innerHTML = photosHtml;
                } else {
                    photoContent.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Gagal memuat foto: ${data.error}
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error fetching photos:', error);
                const photoContent = document.getElementById('photoContent');
                photoContent.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Terjadi kesalahan saat memuat foto
                    </div>
                `;
            });
    };
    
    // Global Approval Functions for Attendance Approval System
    window.showApprovalModal = function(approvalId, employeeName, barcodeType, scanTime, employeeReason) {
        console.log('showApprovalModal called with:', { approvalId, employeeName, barcodeType, scanTime, employeeReason });
        
        // Store current approval ID globally
        window.currentApprovalId = approvalId;
        
        // Populate modal data
        const modalEmployeeName = document.getElementById('modalEmployeeName');
        const modalBarcodeType = document.getElementById('modalBarcodeType');
        const modalScanTime = document.getElementById('modalScanTime');
        const modalEmployeeReason = document.getElementById('modalEmployeeReason');
        
        if (modalEmployeeName) modalEmployeeName.textContent = employeeName;
        if (modalBarcodeType) modalBarcodeType.textContent = barcodeType.toUpperCase();
        if (modalScanTime) modalScanTime.textContent = scanTime;
        if (modalEmployeeReason) modalEmployeeReason.textContent = employeeReason || 'No reason provided';
        
        // Reset form
        const penaltyType = document.getElementById('penaltyType');
        const reviewerNotes = document.getElementById('reviewerNotes');
        
        if (penaltyType) penaltyType.value = 'none';
        if (reviewerNotes) reviewerNotes.value = '';
        
        // Show modal
        const modalElement = document.getElementById('approvalModal');
        if (modalElement) {
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
            console.log('Approval modal shown successfully');
        } else {
            console.error('Approval modal element not found');
            alert('Error: Modal not found');
        }
    };

    window.processApproval = function(action) {
        const currentApprovalId = window.currentApprovalId;
        
        if (!currentApprovalId) {
            alert('Error: No approval ID found');
            return;
        }
        
        const penaltyType = document.getElementById('penaltyType')?.value || 'none';
        const reviewerNotes = document.getElementById('reviewerNotes')?.value || '';
        
        console.log('Processing approval:', { action, currentApprovalId, penaltyType, reviewerNotes });
        
        // Show loading
        const approveBtn = document.querySelector('[onclick="processApproval(\'approve\')"]');
        const rejectBtn = document.querySelector('[onclick="processApproval(\'reject\')"]');
        
        if (action === 'approve' && approveBtn) {
            approveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
            approveBtn.disabled = true;
        } else if (action === 'reject' && rejectBtn) {
            rejectBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
            rejectBtn.disabled = true;
        }
        
        // Send request
        fetch(`/attendance/approve/${currentApprovalId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: action,
                penalty_type: penaltyType,
                notes: reviewerNotes
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('Approval response:', data);
            
            if (data.success) {
                // Close modal
                const modalElement = document.getElementById('approvalModal');
                if (modalElement) {
                    const modal = bootstrap.Modal.getInstance(modalElement);
                    if (modal) modal.hide();
                }
                
                // Show success message
                alert(`Request ${action === 'approve' ? 'approved' : 'rejected'} successfully!`);
                
                // Reload page to update the list
                window.location.reload();
            } else {
                alert('Error: ' + (data.message || 'Unknown error'));
                
                // Reset buttons
                if (action === 'approve' && approveBtn) {
                    approveBtn.innerHTML = '<i class="fas fa-check me-2"></i>Approve';
                    approveBtn.disabled = false;
                } else if (action === 'reject' && rejectBtn) {
                    rejectBtn.innerHTML = '<i class="fas fa-times me-2"></i>Reject';
                    rejectBtn.disabled = false;
                }
            }
        })
        .catch(error => {
            console.error('Error processing approval:', error);
            alert('Terjadi kesalahan saat memproses approval');
            
            // Reset buttons
            if (action === 'approve' && approveBtn) {
                approveBtn.innerHTML = '<i class="fas fa-check me-2"></i>Approve';
                approveBtn.disabled = false;
            } else if (action === 'reject' && rejectBtn) {
                rejectBtn.innerHTML = '<i class="fas fa-times me-2"></i>Reject';
                rejectBtn.disabled = false;
            }
        });
    };
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>