{% extends "base.html" %}

{% block title %}Ready Pickup Mode - STRONG Order Management{% endblock %}

{% block extra_head %}
<style>
/* Ready Pickup Mode Specific Styling */
.pickup-header {
    background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
    border-radius: 20px;
    padding: 3rem 2rem;
    margin-bottom: 3rem;
    position: relative;
    overflow: hidden;
    box-shadow: 0 10px 40px rgba(40, 167, 69, 0.3);
}

.pickup-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="2" fill="rgba(255,255,255,0.1)"/></svg>') repeat;
    background-size: 50px 50px;
    animation: float 20s infinite linear;
}

@keyframes float {
    0% { transform: translateY(0px); }
    100% { transform: translateY(-50px); }
}

.pickup-card {
    background: rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(15px);
    border: 2px solid rgba(40, 167, 69, 0.2);
    border-radius: 20px;
    transition: all 0.4s ease;
    position: relative;
    overflow: hidden;
}

.pickup-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 60px rgba(40, 167, 69, 0.4);
    border-color: rgba(40, 167, 69, 0.5);
}

.scan-input-pickup {
    background: rgba(255, 255, 255, 0.12);
    border: 2px solid rgba(255, 255, 255, 0.2);
    border-radius: 15px;
    padding: 1.5rem;
    color: white;
    font-size: 1.2rem;
    transition: all 0.3s ease;
    width: 100%;
}

.scan-input-pickup:focus {
    background: rgba(255, 255, 255, 0.18);
    border-color: #28a745;
    box-shadow: 0 0 0 4px rgba(40, 167, 69, 0.2);
    outline: none;
}

.scan-input-pickup::placeholder {
    color: rgba(255, 255, 255, 0.6);
}

.scan-button-pickup {
    background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
    border: none;
    border-radius: 15px;
    padding: 1.5rem 3rem;
    color: white;
    font-weight: 700;
    font-size: 1.2rem;
    transition: all 0.3s ease;
    box-shadow: 0 5px 20px rgba(40, 167, 69, 0.3);
}

.scan-button-pickup:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 30px rgba(40, 167, 69, 0.5);
}

.camera-btn-pickup {
    background: rgba(255, 255, 255, 0.15);
    border: 2px solid rgba(255, 255, 255, 0.25);
    border-radius: 15px;
    padding: 1.5rem;
    color: white;
    transition: all 0.3s ease;
    font-size: 1.5rem;
}

.camera-btn-pickup:hover {
    background: rgba(255, 255, 255, 0.25);
    color: white;
    transform: scale(1.05);
}

.back-btn {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    padding: 0.8rem 1.5rem;
    color: white;
    text-decoration: none;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.back-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    transform: translateY(-2px);
}

.status-badge-pickup {
    background: rgba(40, 167, 69, 0.2);
    color: #90ee90;
    border: 1px solid rgba(40, 167, 69, 0.3);
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 600;
}

.ready-success {
    background: rgba(40, 167, 69, 0.1);
    border: 1px solid rgba(40, 167, 69, 0.3);
    border-radius: 15px;
    padding: 1.5rem;
    margin-top: 1.5rem;
}

.recent-scans {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 15px;
    padding: 1.5rem;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.scan-history-item {
    background: rgba(255, 255, 255, 0.08);
    border-radius: 10px;
    padding: 1rem;
    margin-bottom: 0.5rem;
    border-left: 4px solid #28a745;
    animation: slideInRight 0.3s ease-out;
}

@keyframes slideInRight {
    from {
        opacity: 0;
        transform: translateX(20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.success-icon-wrapper {
    animation: pulse-success 2s infinite;
}

@keyframes pulse-success {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}
</style>
{% endblock %}

{% block content %}
<!-- Back Navigation -->
<div class="mb-3">
    <a href="{{ url_for('scan_center') }}" class="back-btn">
        <i class="fas fa-arrow-left"></i>
        <span>Kembali ke Scan Center</span>
    </a>
</div>

<!-- Ready Pickup Header -->
<div class="pickup-header text-white text-center">
    <div class="position-relative">
        <h1 class="display-4 fw-bold mb-2">
            <i class="fas fa-truck me-3"></i>Mode Ready Pickup
        </h1>
        <p class="lead mb-3">Scan nomor resi untuk menandai pesanan siap diambil kurir</p>
        <div class="status-badge-pickup">
            <i class="fas fa-truck me-2"></i>Staff Ready Pickup
        </div>
    </div>
</div>

<!-- Main Ready Pickup Interface -->
<div class="row justify-content-center mb-5">
    <div class="col-lg-8 col-md-10">
        <div class="pickup-card">
            <div class="p-5 text-center">
                <div class="mb-5">
                    <div class="mx-auto mb-4" style="width: 100px; height: 100px; background: linear-gradient(135deg, #28a745, #1e7e34); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 30px rgba(40, 167, 69, 0.4);">
                        <i class="fas fa-truck fa-3x text-white"></i>
                    </div>
                    <h3 class="text-white mb-3">Scan Nomor Resi</h3>
                    <p class="text-light">Masukkan atau scan nomor resi pesanan yang sudah dikemas</p>
                </div>
                
                <form id="scanReadyForm">
                    <div class="mb-4">
                        <div class="d-flex gap-3 justify-content-center align-items-end">
                            <div style="flex: 1; max-width: 500px;">
                                <input type="text" class="scan-input-pickup" id="readyBarcode" 
                                       placeholder="Masukkan nomor resi" autofocus>
                            </div>
                            <button class="camera-btn-pickup" type="button" onclick="openReadyCameraScanner()">
                                <i class="fas fa-camera"></i>
                            </button>
                        </div>
                    </div>
                    
                    <button type="submit" class="scan-button-pickup">
                        <i class="fas fa-check me-2"></i>Tandai Siap Pickup
                    </button>
                    
                    <!-- Test Audio Buttons -->
                    <div class="mt-3">
                        <button type="button" class="btn btn-success me-2" onclick="testSuccessSound()">
                            <i class="fas fa-check me-2"></i>Test Suara Berhasil
                        </button>
                        <button type="button" class="btn btn-danger" onclick="testErrorSound()">
                            <i class="fas fa-times me-2"></i>Test Suara Gagal
                        </button>
                    </div>
                </form>
                
                <div id="readyScanResult" class="mt-4"></div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Instructions -->
    <div class="col-lg-6 mb-4">
        <div class="pickup-card">
            <div class="p-4">
                <h5 class="text-white mb-4 text-center">
                    <i class="fas fa-info-circle me-2"></i>Cara Menggunakan Mode Ready Pickup
                </h5>
                
                <div class="d-flex flex-column gap-3">
                    <div class="d-flex align-items-start gap-3">
                        <div class="flex-shrink-0">
                            <div style="width: 40px; height: 40px; background: #28a745; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <span class="text-white fw-bold">1</span>
                            </div>
                        </div>
                        <div>
                            <h6 class="text-white mb-1">Pastikan Pesanan Sudah Dikemas</h6>
                            <small class="text-muted">Verifikasi bahwa pesanan sudah melalui proses packing</small>
                        </div>
                    </div>
                    
                    <div class="d-flex align-items-start gap-3">
                        <div class="flex-shrink-0">
                            <div style="width: 40px; height: 40px; background: #28a745; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <span class="text-white fw-bold">2</span>
                            </div>
                        </div>
                        <div>
                            <h6 class="text-white mb-1">Scan Nomor Resi</h6>
                            <small class="text-muted">Scan atau input nomor resi yang tertera di paket</small>
                        </div>
                    </div>
                    
                    <div class="d-flex align-items-start gap-3">
                        <div class="flex-shrink-0">
                            <div style="width: 40px; height: 40px; background: #28a745; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <span class="text-white fw-bold">3</span>
                            </div>
                        </div>
                        <div>
                            <h6 class="text-white mb-1">Konfirmasi Ready</h6>
                            <small class="text-muted">Sistem akan menandai pesanan siap diambil kurir</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Scans -->
    <div class="col-lg-6 mb-4">
        <div class="recent-scans">
            <h5 class="text-white mb-4 text-center">
                <i class="fas fa-history me-2"></i>Riwayat Scan
                {% if scan_history %}
                    <span class="badge bg-info ms-2">{{ scan_history.total }}</span>
                {% endif %}
            </h5>
            
            <div id="recentScans" style="max-height: 400px; overflow-y: auto;">
                <div class="scan-history-items">
                    {% if scan_history and scan_history.items %}
                        {% for scan in scan_history.items %}
                        <div class="scan-history-item mb-3 p-3 border rounded">
                            <div class="d-flex align-items-start">
                                <div class="me-3">
                                    {% if scan.success %}
                                        <div class="success-icon-wrapper">
                                            <i class="fas fa-check-circle text-success fa-lg"></i>
                                        </div>
                                    {% else %}
                                        <i class="fas fa-times-circle text-danger fa-lg"></i>
                                    {% endif %}
                                </div>
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between align-items-start mb-1">
                                        <div>
                                            <strong class="text-white">Resi Scan</strong>
                                            {% if scan.success %}
                                                <span class="badge bg-success ms-2">
                                                    <i class="fas fa-check me-1"></i>✓ BERHASIL
                                                </span>
                                            {% else %}
                                                <span class="badge bg-danger ms-2">✗ GAGAL</span>
                                            {% endif %}
                                        </div>
                                        <small class="text-muted">{{ scan.scanned_at.strftime('%H:%M:%S') }}</small>
                                    </div>
                                    <div class="text-light small mb-1">
                                        <strong>Nomor Resi:</strong> {{ scan.barcode }}
                                    </div>
                                    <div class="text-light small mb-1">
                                        {{ scan.message }}
                                    </div>
                                    {% if scan.success %}
                                    <div class="text-info small">
                                        <i class="fas fa-user me-1"></i>{{ scan.customer_name }}
                                        <i class="fas fa-receipt ms-2 me-1"></i>{{ scan.order_number }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
                    
                    <!-- Pagination -->
                    {% if scan_history.pages > 1 %}
                    <div class="d-flex justify-content-center mt-3">
                        <nav aria-label="Page navigation">
                            <ul class="pagination pagination-sm">
                                {% if scan_history.has_prev %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('scan_ready_pickup_page', page=scan_history.prev_num) }}">
                                        <i class="fas fa-chevron-left"></i>
                                    </a>
                                </li>
                                {% endif %}
                                
                                {% for page_num in scan_history.iter_pages() %}
                                    {% if page_num %}
                                        {% if page_num != scan_history.page %}
                                        <li class="page-item">
                                            <a class="page-link" href="{{ url_for('scan_ready_pickup_page', page=page_num) }}">{{ page_num }}</a>
                                        </li>
                                        {% else %}
                                        <li class="page-item active">
                                            <span class="page-link">{{ page_num }}</span>
                                        </li>
                                        {% endif %}
                                    {% else %}
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                    {% endif %}
                                {% endfor %}
                                
                                {% if scan_history.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('scan_ready_pickup_page', page=scan_history.next_num) }}">
                                        <i class="fas fa-chevron-right"></i>
                                    </a>
                                </li>
                                {% endif %}
                            </ul>
                        </nav>
                    </div>
                    {% endif %}
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-clock fa-2x mb-2"></i>
                        <p>Belum ada scan hari ini</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Camera Scanner Modal -->
<div class="modal fade" id="readyCameraModal" tabindex="-1" aria-labelledby="readyCameraModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="max-width: 420px;">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title" id="readyCameraModalLabel">
                    <i class="fas fa-qrcode me-2"></i>Scan Nomor Resi
                </h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-3">
                <div class="position-relative mb-3">
                    <video id="readyCameraVideo" 
                           style="width: 100%; height: 280px; object-fit: cover; border: 2px solid #28a745; border-radius: 8px; background: #000;"></video>
                    
                    <div class="position-absolute top-50 start-50 translate-middle" 
                         style="width: 200px; height: 200px; border: 2px solid #28a745; border-radius: 8px; background: transparent;">
                        <div class="position-absolute" style="top: -2px; left: -2px; width: 30px; height: 30px; border-left: 4px solid #28a745; border-top: 4px solid #28a745;"></div>
                        <div class="position-absolute" style="top: -2px; right: -2px; width: 30px; height: 30px; border-right: 4px solid #28a745; border-top: 4px solid #28a745;"></div>
                        <div class="position-absolute" style="bottom: -2px; left: -2px; width: 30px; height: 30px; border-left: 4px solid #28a745; border-bottom: 4px solid #28a745;"></div>
                        <div class="position-absolute" style="bottom: -2px; right: -2px; width: 30px; height: 30px; border-right: 4px solid #28a745; border-bottom: 4px solid #28a745;"></div>
                    </div>
                </div>
                
                <div class="text-center mb-3">
                    <div class="alert alert-info py-2" id="readyScanStatus">
                        <i class="fas fa-info-circle me-2"></i>Memulai kamera...
                    </div>
                    <div class="alert alert-success py-2" id="readyScanResultModal" style="display: none;">
                        <strong>Hasil Scan:</strong> <span id="readyScannedCode"></span>
                    </div>
                </div>
                
                <div class="text-center">
                    <small class="text-muted">Scanner akan otomatis menggunakan hasil scan</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="readySuccessModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle me-2"></i>Berhasil!
                </h5>
            </div>
            <div class="modal-body text-center">
                <i class="fas fa-truck text-success fa-4x mb-3"></i>
                <h4 id="successOrderTitle">Pesanan Siap Diambil!</h4>
                <p id="successOrderDetails">Pesanan telah ditandai siap untuk diambil kurir.</p>
            </div>
            <div class="modal-footer justify-content-center">
                <div class="d-grid gap-2 w-100">
                    <button type="button" class="btn btn-success btn-lg" onclick="window.location.reload()">
                        <i class="fas fa-qrcode me-2"></i>Scan Resi Lagi
                    </button>
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Tutup
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- ZXing Barcode Scanner Library -->
<script src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script>

<script>
// Global variables for barcode scanner
let readyCameraStream = null;
let readyScannedData = null;
let readyCodeReader = null;
let recentScans = [];

// Function to open ready barcode scanner
function openReadyCameraScanner() {
    const modal = new bootstrap.Modal(document.getElementById('readyCameraModal'));
    const video = document.getElementById('readyCameraVideo');
    const statusDiv = document.getElementById('readyScanStatus');
    const resultDiv = document.getElementById('readyScanResultModal');
    const scannedCodeSpan = document.getElementById('readyScannedCode');
    
    resultDiv.style.display = 'none';
    statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Memulai scanner barcode...';
    
    modal.show();
    
    readyCodeReader = new ZXing.BrowserMultiFormatReader();
    
    readyCodeReader.decodeFromVideoDevice(null, video, (result, err) => {
        if (result) {
            const scannedCode = result.getText();
            readyScannedData = scannedCode;
            scannedCodeSpan.textContent = scannedCode;
            resultDiv.style.display = 'block';
            statusDiv.innerHTML = '<i class="fas fa-check-circle me-2"></i>Berhasil scan! Menggunakan kode: ' + scannedCode;
            
            if (navigator.vibrate) {
                navigator.vibrate(200);
            }
            
            document.getElementById('readyBarcode').value = scannedCode;
            
            setTimeout(() => {
                modal.hide();
                const form = document.getElementById('scanReadyForm');
                if (form) {
                    form.dispatchEvent(new Event('submit'));
                }
            }, 1000);
        }
        
        if (err && !(err instanceof ZXing.NotFoundException)) {
            console.error('Barcode scan error:', err);
            statusDiv.innerHTML = '<i class="fas fa-camera me-2"></i>Arahkan kamera ke barcode nomor resi';
        } else if (!result) {
            statusDiv.innerHTML = '<i class="fas fa-camera me-2"></i>Arahkan kamera ke barcode nomor resi';
        }
    })
    .catch(error => {
        console.error('Camera error:', error);
        statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Tidak dapat mengakses kamera. Pastikan izin kamera diaktifkan.';
    });
    
    document.getElementById('readyCameraModal').addEventListener('hidden.bs.modal', function() {
        if (readyCodeReader) {
            readyCodeReader.reset();
            readyCodeReader = null;
        }
    });
}


// Global audio elements for success and error sounds
let successAudio = null;
let errorAudio = null;

// Function to initialize success sound
function initSuccessSound() {
    if (!successAudio) {
        console.log('Creating new Audio element...');
        
        // Try multiple audio formats and sources
        successAudio = new Audio();
        successAudio.preload = 'auto';
        successAudio.volume = 1.0;
        
        // Add multiple source attempts
        const sources = [
            '/static/sounds/success.wav',
            'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWskBjiS1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvWs='
        ];
        
        // Try to set the source
        successAudio.src = sources[0];
        
        // Add event listeners for debugging
        successAudio.addEventListener('loadstart', () => console.log('Success Audio: loadstart'));
        successAudio.addEventListener('loadeddata', () => console.log('Success Audio: loadeddata'));
        successAudio.addEventListener('canplay', () => console.log('Success Audio: canplay'));
        successAudio.addEventListener('canplaythrough', () => console.log('Success Audio: canplaythrough'));
        successAudio.addEventListener('error', (e) => {
            console.error('Success Audio error:', e);
            console.error('Success Audio error details:', successAudio.error);
            // Try fallback if file fails
            if (sources.length > 1) {
                console.log('Trying fallback audio source...');
                successAudio.src = sources[1];
            }
        });
        
        console.log('Audio element created:', successAudio);
        console.log('Audio source:', successAudio.src);
    }
}

// Function to initialize error sound
function initErrorSound() {
    if (!errorAudio) {
        console.log('Creating error audio element...');
        errorAudio = new Audio();
        errorAudio.preload = 'auto';
        errorAudio.volume = 1.0;
        errorAudio.src = '/static/sounds/error.wav';
        
        // Add event listeners for debugging
        errorAudio.addEventListener('loadstart', () => console.log('Error Audio: loadstart'));
        errorAudio.addEventListener('loadeddata', () => console.log('Error Audio: loadeddata'));
        errorAudio.addEventListener('canplay', () => console.log('Error Audio: canplay'));
        errorAudio.addEventListener('canplaythrough', () => console.log('Error Audio: canplaythrough'));
        errorAudio.addEventListener('error', (e) => {
            console.error('Error Audio error:', e);
            console.error('Error Audio error details:', errorAudio.error);
        });
        
        console.log('Error Audio element created:', errorAudio);
        console.log('Error Audio source:', errorAudio.src);
    }
}

// Function to play success sound
function playSuccessSound() {
    console.log('Attempting to play success sound...');
    try {
        if (!successAudio) {
            console.log('Initializing success audio...');
            initSuccessSound();
        }
        
        console.log('Audio element:', successAudio);
        console.log('Audio src:', successAudio.src);
        
        // Reset audio to beginning and play
        successAudio.currentTime = 0;
        successAudio.volume = 1.0; // Full volume for testing
        
        const playPromise = successAudio.play();
        console.log('Play promise:', playPromise);
        
        if (playPromise !== undefined) {
            playPromise.then(() => {
                console.log('Audio played successfully!');
            }).catch(error => {
                console.log('Audio play prevented:', error);
                // Fallback to Web Audio API if file doesn't work
                playFallbackSound();
            });
        }
    } catch (error) {
        console.error('Error playing success sound:', error);
        // Fallback to Web Audio API
        playFallbackSound();
    }
}

// Function to play error sound
function playErrorSound() {
    console.log('Attempting to play error sound...');
    try {
        if (!errorAudio) {
            console.log('Initializing error audio...');
            initErrorSound();
        }
        
        console.log('Error Audio element:', errorAudio);
        console.log('Error Audio src:', errorAudio.src);
        
        // Reset audio to beginning and play
        errorAudio.currentTime = 0;
        errorAudio.volume = 1.0; // Full volume for testing
        
        const playPromise = errorAudio.play();
        console.log('Error Play promise:', playPromise);
        
        if (playPromise !== undefined) {
            playPromise.then(() => {
                console.log('Error Audio played successfully!');
            }).catch(error => {
                console.log('Error Audio play prevented:', error);
            });
        }
    } catch (error) {
        console.error('Error playing error sound:', error);
    }
}

// Fallback sound using Web Audio API
function playFallbackSound() {
    console.log('Playing fallback sound...');
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        console.log('AudioContext created:', audioContext);
        
        // Create a sequence of tones for success sound
        const frequencies = [523.25, 659.25, 783.99]; // C5, E5, G5
        const duration = 0.2;
        
        frequencies.forEach((freq, index) => {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = freq;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.5, audioContext.currentTime + index * duration);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + (index + 1) * duration);
            
            oscillator.start(audioContext.currentTime + index * duration);
            oscillator.stop(audioContext.currentTime + (index + 1) * duration);
        });
        
        console.log('Fallback sound played successfully!');
    } catch (error) {
        console.error('Fallback audio also failed:', error);
    }
}

// Test success sound function
function testSuccessSound() {
    console.log('=== TESTING SUCCESS SOUND ===');
    
    // Initialize and play success sound
    initSuccessSound();
    playSuccessSound();
    
    // Show visual feedback
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Memainkan suara...';
    button.disabled = true;
    
    setTimeout(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    }, 2000);
}

// Test error sound function
function testErrorSound() {
    console.log('=== TESTING ERROR SOUND ===');
    
    // Initialize and play error sound
    initErrorSound();
    playErrorSound();
    
    // Show visual feedback
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Memainkan suara...';
    button.disabled = true;
    
    setTimeout(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    }, 2000);
}

// Test audio function (legacy, for backward compatibility)
function testAudio() {
    console.log('=== TESTING AUDIO ===');
    
    // Simple immediate beep test
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        console.log('AudioContext state:', audioContext.state);
        
        if (audioContext.state === 'suspended') {
            console.log('Resuming audio context...');
            audioContext.resume().then(() => {
                console.log('Audio context resumed');
                playSimpleBeep(audioContext);
            });
        } else {
            playSimpleBeep(audioContext);
        }
    } catch (error) {
        console.error('Audio context creation failed:', error);
    }
    
    // Test 1: File audio
    console.log('Test 1: Playing file audio...');
    playSuccessSound();
    
    // Test 2: Fallback audio after 2 seconds
    setTimeout(() => {
        console.log('Test 2: Playing fallback audio...');
        playFallbackSound();
    }, 2000);
}

function playSimpleBeep(audioContext) {
    try {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.3);
        
        console.log('Simple beep should play now!');
    } catch (error) {
        console.error('Simple beep failed:', error);
    }
}

// Add scan to recent scans
function addRecentScan(resi, time, success = true, message = '', order_number = '', customer_name = '') {
    recentScans.unshift({resi, time, success, message, order_number, customer_name});
    if (recentScans.length > 10) {
        recentScans.pop();
    }
    updateRecentScansDisplay();
}

// Add new scan to history display with animation
function addNewScanToHistory(resi, time, success, message, order_number, customer_name) {
    const container = document.querySelector('#recentScans .scan-history-items');
    if (!container) return;
    
    const newScanHTML = `
        <div class="scan-history-item mb-3 p-3 border rounded" style="animation: slideInRight 0.5s ease-out;">
            <div class="d-flex align-items-start">
                <div class="me-3">
                    ${success ? 
                        '<div class="success-icon-wrapper"><i class="fas fa-check-circle text-success fa-lg"></i></div>' : 
                        '<i class="fas fa-times-circle text-danger fa-lg"></i>'
                    }
                </div>
                <div class="flex-grow-1">
                    <div class="d-flex justify-content-between align-items-start mb-1">
                        <div>
                            <strong class="text-white">Resi Scan</strong>
                            ${success ? 
                                '<span class="badge bg-success ms-2"><i class="fas fa-check me-1"></i>✓ BERHASIL</span>' : 
                                '<span class="badge bg-danger ms-2">✗ GAGAL</span>'
                            }
                        </div>
                        <small class="text-muted">${time}</small>
                    </div>
                    <div class="text-light small mb-1">
                        <strong>Nomor Resi:</strong> ${resi}
                    </div>
                    <div class="text-light small mb-1">
                        ${message}
                    </div>
                    ${success && customer_name !== 'N/A' ? `
                        <div class="text-info small">
                            <i class="fas fa-user me-1"></i>${customer_name}
                            <i class="fas fa-receipt ms-2 me-1"></i>${order_number}
                        </div>
                    ` : ''}
                </div>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('afterbegin', newScanHTML);
    
    // Remove oldest items if more than 10
    const items = container.querySelectorAll('.scan-history-item');
    if (items.length > 10) {
        items[items.length - 1].remove();
    }
}

// Update recent scans display
function updateRecentScansDisplay() {
    const container = document.querySelector('#recentScans .scan-history-items');
    if (!container) return;
    
    if (recentScans.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-clock fa-2x mb-2"></i>
                <p>Belum ada scan hari ini</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = recentScans.map(scan => `
        <div class="scan-history-item">
            <div class="d-flex align-items-start">
                <div class="me-3">
                    ${scan.success ? 
                        '<div class="success-icon-wrapper"><i class="fas fa-check-circle text-success fa-lg"></i></div>' : 
                        '<i class="fas fa-times-circle text-danger fa-lg"></i>'
                    }
                </div>
                <div class="flex-grow-1">
                    <div class="d-flex justify-content-between align-items-start mb-1">
                        <div>
                            <strong class="text-white">Resi Scan</strong>
                            ${scan.success ? 
                                '<span class="badge bg-success ms-2"><i class="fas fa-check me-1"></i>✓ BERHASIL</span>' : 
                                '<span class="badge bg-danger ms-2">✗ GAGAL</span>'
                            }
                        </div>
                        <small class="text-muted">${scan.time}</small>
                    </div>
                    <div class="text-light small mb-1">
                        <strong>Nomor Resi:</strong> ${scan.resi}
                    </div>
                    ${scan.message ? `<div class="text-light small mb-1">${scan.message}</div>` : ''}
                    ${scan.success && scan.customer_name ? `
                        <div class="text-info small">
                            <i class="fas fa-user me-1"></i>${scan.customer_name}
                            <i class="fas fa-receipt ms-2 me-1"></i>${scan.order_number}
                        </div>
                    ` : ''}
                </div>
            </div>
        </div>
    `).join('');
}

document.addEventListener('DOMContentLoaded', function() {
    // Initialize success sound
    initSuccessSound();
    
    const readyForm = document.getElementById('scanReadyForm');
    const readyBarcodeInput = document.getElementById('readyBarcode');
    
    if (readyForm) {
        readyForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const barcode = readyBarcodeInput.value.trim();
            
            if (!barcode) {
                alert('Silakan masukkan nomor resi');
                return;
            }
            
            // Show loading state
            const resultDiv = document.getElementById('readyScanResult');
            resultDiv.innerHTML = `
                <div class="ready-success text-center">
                    <div class="spinner-border text-success mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="text-light">Memproses nomor resi: <strong>${barcode}</strong></p>
                </div>
            `;
            
            // Send AJAX request to server
            const formData = new FormData();
            formData.append('barcode', barcode);
            
            fetch('/scan/ready_pickup', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Play success sound
                    playSuccessSound();
                    
                    // Add to recent scans
                    const now = new Date();
                    const timeStr = now.toLocaleTimeString('id-ID', {hour: '2-digit', minute: '2-digit'});
                    addRecentScan(barcode, timeStr, true);
                    
                    // Show success result
                    resultDiv.innerHTML = `
                        <div class="ready-success text-center">
                            <div class="success-icon-wrapper mb-3">
                                <i class="fas fa-check-circle text-success fa-4x"></i>
                            </div>
                            <h4 class="text-success mb-2">✓ Scan Berhasil!</h4>
                            <p class="text-light"><strong>Resi:</strong> ${barcode}</p>
                            <p class="text-light">${data.message}</p>
                            <small class="text-muted">Order: ${data.order_number} - ${data.customer_name}</small>
                        </div>
                    `;
                    
                    // Add new scan to history display
                    addNewScanToHistory(barcode, timeStr, true, data.message, data.order_number, data.customer_name);
                    
                    // Clear form after 3 seconds
                    setTimeout(() => {
                        readyBarcodeInput.value = '';
                        resultDiv.innerHTML = '';
                    }, 3000);
                    
                } else {
                    // Show error result
                    resultDiv.innerHTML = `
                        <div class="alert alert-danger text-center">
                            <i class="fas fa-times-circle fa-2x mb-2"></i>
                            <h5>Scan Gagal</h5>
                            <p><strong>Resi:</strong> ${barcode}</p>
                            <p>${data.error}</p>
                        </div>
                    `;
                    
                    // Add to recent scans as failed
                    const now = new Date();
                    const timeStr = now.toLocaleTimeString('id-ID', {hour: '2-digit', minute: '2-digit'});
                    addRecentScan(barcode, timeStr, false);
                    addNewScanToHistory(barcode, timeStr, false, data.error, 'N/A', 'N/A');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                resultDiv.innerHTML = `
                    <div class="alert alert-danger text-center">
                        <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                        <h5>Error</h5>
                        <p>Gagal memproses scan. Silakan coba lagi.</p>
                    </div>
                `;
            });
        });
    }
    
    if (readyBarcodeInput) {
        readyBarcodeInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                readyForm.dispatchEvent(new Event('submit'));
            }
        });
        
        // Initialize audio context on first user interaction
        readyBarcodeInput.addEventListener('click', function() {
            console.log('Input clicked - initializing audio...');
            initSuccessSound();
        });
        
        // Test audio button for debugging
        readyBarcodeInput.addEventListener('focus', function() {
            console.log('Input focused - testing audio...');
            // Test both audio methods
            setTimeout(() => {
                console.log('Testing audio in 1 second...');
                playSuccessSound();
            }, 1000);
        });
    }
    
    // Initialize recent scans display
    updateRecentScansDisplay();
});
</script>
{% endblock %}